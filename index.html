<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>КП Конструктор — тёмная тема, анимации, быстрые варианты</title>
<style>
  :root{
    --bg:#0b0e12; --card:#11151c; --line:#212631; --fg:#e6e7eb; --muted:#95a1b2;
    --accent:#ffffff; --accent-2:#bfc7d8; --chip:#161b22; --chip-br:#2a3140;
    --chip-hover:#1f2530; --chip-active:#2a3140; --danger:#ff4d4f; --ok:#5bef8a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
    font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  a{color:var(--accent)}
  header{border-bottom:1px solid var(--line);padding:16px 20px;display:flex;gap:16px;align-items:center;justify-content:space-between;background:#0a0d11;position:sticky;top:0;z-index:5}
  header h1{margin:0;font-size:18px;font-weight:600;letter-spacing:.3px}
  .tabs{display:flex;gap:6px}
  .tab{border:1px solid var(--line);padding:8px 12px;cursor:pointer;border-radius:999px;background:var(--chip);color:var(--accent-2);transition:.25s ease;transform:translateZ(0)}
  .tab:hover{border-color:var(--accent-2);color:var(--accent)}
  .tab.active{background:#ffffff10;border-color:#ffffff44;color:#fff;box-shadow:0 0 0 1px #ffffff22 inset}
  main{max-width:1100px;margin:24px auto;padding:0 20px}
  .panel{display:none;animation:fadeIn .35s ease}
  .panel.active{display:block}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
  .card{border:1px solid var(--line);border-radius:16px;padding:14px;background:var(--card);box-shadow:0 10px 30px #00000033}
  .title{font-size:13px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:8px}
  .meta{font-size:12px;color:var(--muted)}
  .hr{border-top:1px solid var(--line);margin:14px 0}
  /* CHAT */
  .chat{height:520px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:10px;border:1px dashed var(--line);border-radius:14px;background:#0d1117;scroll-behavior:smooth}
  .msg{max-width:82%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);animation:slideUp .25s ease}
  .msg.bot{align-self:flex-start;background:#0f141c}
  .msg.user{align-self:flex-end;background:#0b0e12;border-color:#ffffff33;box-shadow:0 0 0 1px #ffffff16 inset}
  .typing{width:46px;height:14px;display:flex;gap:6px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:#0f141c}
  .typing i{width:6px;height:6px;border-radius:50%;background:#74839a;animation:blink 1.2s infinite}
  .typing i:nth-child(2){animation-delay:.2s}
  .typing i:nth-child(3){animation-delay:.4s}
  .inputbar{display:flex;gap:8px;margin-top:10px}
  .inputbar input[type="text"], .inputbar textarea{flex:1;padding:12px 12px;border:1px solid var(--line);border-radius:12px;min-height:44px;background:#0d1117;color:var(--fg);outline:none;transition:border .2s ease}
  .inputbar input:focus{border-color:#ffffff44}
  .btn{border:1px solid var(--line);background:#0f141c;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s ease}
  .btn:hover{border-color:#ffffff44;background:#121a25}
  .btn.black{background:#ffffff14;color:#fff;border-color:#ffffff44}
  .btn.black:hover{background:#ffffff22}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  .chip{border:1px solid var(--chip-br);padding:8px 12px;border-radius:999px;cursor:pointer;background:var(--chip);color:#d7deee;transition:transform .06s ease, background .2s ease, border .2s ease;animation:pop .18s ease}
  .chip:hover{background:var(--chip-hover);border-color:#3a4254}
  .chip:active{transform:scale(.97);background:var(--chip-active)}
  .chip.ghost{border-style:dashed;color:#b7bfd1}
  .chip.suggest{border-color:#4a5368;background:#111827}
  .progress{height:10px;background:#0d1117;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
  .bar{height:100%;background:linear-gradient(90deg,#7f8cff,#5be2ff);width:0%;transition:width .35s ease}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:6px;margin:6px 0}
  .kv div:first-child{color:var(--muted)}
  .files{display:flex;flex-wrap:wrap;gap:8px}
  .filepill{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#0d1117;color:#c7d2e2}
  pre, textarea.output{width:100%;min-height:220px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#0d1117;color:#e7e9ef;white-space:pre-wrap}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .hidden{display:none !important}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  @keyframes slideUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pop{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
  @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>
<header>
  <h1>КП Конструктор — тёмная тема + анимации</h1>
  <div class="tabs">
    <div class="tab active" data-tab="form">Форма + чат</div>
    <div class="tab" data-tab="files">Анализ файла</div>
  </div>
</header>

<main>
  <!-- ===== FORM/CHAT ===== -->
  <section id="panel-form" class="panel active">
    <div class="grid">
      <div class="card">
        <div class="title">Чат</div>
        <div id="chat" class="chat" aria-live="polite"></div>
        <div id="quick" class="chips"></div>
        <div class="inputbar">
          <input id="answer" type="text" placeholder="Введите ответ… (или нажмите на чип выше)" />
          <button id="send" class="btn black">Отправить</button>
          <label class="btn">
            Прикрепить
            <input id="fileInputForm" type="file" multiple class="hidden" />
          </label>
        </div>
        <div class="meta">Совет: «Нет информации» доступно для любого вопроса — ответ пометится как пробел.</div>
      </div>

      <div class="card">
        <div class="title">Прогресс</div>
        <div class="kv"><div>Текущий блок</div><div id="curBlock">–</div></div>
        <div class="kv"><div>Вопрос</div><div id="curQ">–</div></div>
        <div class="kv"><div>Заполнено (обяз.)</div><div><span id="filledCount">0</span>/<span id="reqCount">0</span> — <span id="filledPct">0%</span></div></div>
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div class="hr"></div>
        <div class="title">Файлы</div>
        <div id="fileListForm" class="files"></div>
        <div class="hr"></div>
        <div class="right">
          <button id="prev" class="btn">Назад</button>
          <button id="skip" class="btn">Пропустить</button>
          <button id="finish" class="btn black">Сформировать итог</button>
          <button id="reset" class="btn">Сбросить</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="title">Итог (форма + чат)</div>
      <textarea id="finalTextForm" class="output" placeholder="Сводка цитат, оценка полноты и скрипт появятся здесь…"></textarea>
      <div class="right">
        <button id="copyForm" class="btn">Копировать</button>
        <button id="zipForm" class="btn black">Скачать ZIP</button>
      </div>
    </div>
  </section>

  <!-- ===== FILE ANALYSIS ===== -->
  <section id="panel-files" class="panel">
    <div class="card">
      <div class="title">Загрузка</div>
      <div class="chips">
        <input id="fileInputAnalysis" type="file" multiple />
        <button id="analyze" class="btn black">Извлечь и разобрать</button>
      </div>
      <div id="fileListAnalysis" class="files"></div>
      <div class="hr"></div>
      <div class="grid">
        <div class="card">
          <div class="title">Извлечённые цитаты</div>
          <textarea id="extractedText" class="output" placeholder="Текст из PDF/DOCX/TXT появится здесь…"></textarea>
        </div>
        <div class="card">
          <div class="title">Оценка полноты</div>
          <div class="kv"><div>Покрытие</div><div class="ok"><span id="covPct">0%</span></div></div>
          <div class="kv"><div>Хватает</div><div id="covHave">–</div></div>
          <div class="kv"><div>Не хватает</div><div id="covMiss" class="danger">–</div></div>
          <div class="hr"></div>
          <div class="title">Скрипт вопросов для созвона</div>
          <pre id="callScript" style="min-height:160px"></pre>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="title">Черновик концепции КП</div>
      <textarea id="concept" class="output" placeholder="Авто-набросок по ключам из файлов (не цитаты)."></textarea>
      <div class="right">
        <button id="copyFiles" class="btn">Копировать всё</button>
        <button id="zipFiles" class="btn black">Скачать ZIP</button>
      </div>
    </div>
  </section>
</main>

<!-- ===== LIBS ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>if(window['pdfjsLib']) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js';</script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

<script>
/* ========= ВОПРОСЫ ========= */
const QUESTIONS = [
  {id:'client', section:'A1 БАЗА', text:'Кто клиент? (индустрия, размер, специфика)', required:true},
  {id:'problem', section:'A1 БАЗА', text:'Какую проблему решаем? (текстом)', required:true},
  {id:'deadline', section:'A1 БАЗА', text:'Крайний срок/когда нужен результат?', required:true, variantsBtn:true},
  {id:'budget', section:'A1 БАЗА', text:'Есть ориентир по бюджету? (диапазон или «не определён»)', required:true, variantsBtn:true},
  {id:'platform', section:'A2 ПЛАТФОРМА', text:'Платформа: VR / AR / Веб / Мобильное / Киоск / Комбинация', required:true,
    options:['VR','AR','Веб-приложение','Мобильное приложение','Интерактивная панель/киоск','Комбинация']},
  {id:'audience', section:'A3 ЦА', text:'Кто конечные пользователи? (возраст/сфера/подготовка)', required:true},
  {id:'users', section:'A3 ЦА', text:'Сколько пользователей? (один/группа/массово)', required:true, options:['1','Группа','Массово']},
  {id:'place', section:'A3 ЦА', text:'Где будут пользоваться? (офис/выставка/дом/улица)', required:true, options:['Офис','Выставка','Дом','Улица','Комбинация']},
  {id:'script_ready', section:'B1 КОНТЕНТ', text:'Есть готовый сценарий? (да/нет/частично)', required:true, options:['Да','Нет','Частично']},
  {id:'main_idea', section:'B1 КОНТЕНТ', text:'Если сценария нет: какова главная идея?', required:false},
  {id:'duration', section:'B1 КОНТЕНТ', text:'Длительность пользовательского опыта (мин.)', required:true},
  {id:'interaction', section:'B2 ВЗАИМОДЕЙСТВИЕ', text:'Тип взаимодействия: пассивный/активный/обучение/комбинация', required:true, options:['Пассивный просмотр','Активное взаимодействие','Обучение с проверкой знаний','Комбинация']},
  {id:'assets', section:'B3 ВИЗУАЛ', text:'Есть ли 3D-модели? (да/нет/приложу)', required:true, options:['Да','Нет','Приложу файлом']},
  {id:'texts', section:'B3 ВИЗУАЛ', text:'Есть ли тексты/описания? (да/нет/нужна помощь)', required:true, options:['Да','Нет','Нужна помощь']},
  {id:'voice', section:'B3 ВИЗУАЛ', text:'Нужна ли дикторская озвучка? (да/нет)', required:true, options:['Да','Нет']},
  {id:'quality', section:'B3 ВИЗУАЛ', text:'Качество графики: фотореализм/стилизация/простая', required:true, options:['Фотореализм','Стилизованная','Простая']},
  {id:'gear', section:'C1 ОБОРУДОВАНИЕ', text:'Есть ли у клиента VR/AR-оборудование? (какое?)', required:true,
    options:['Pico 4/4 Enterprise','Meta Quest 3','HTC Vive/Pro','HoloLens/AR-устройства','Пока нет']},
  {id:'gear_count', section:'C1 ОБОРУДОВАНИЕ', text:'Сколько комплектов нужно?', required:true, options:['1','2–3','4–8','> 8']},
  {id:'gear_budget', section:'C1 ОБОРУДОВАНИЕ', text:'Оборудование входит в бюджет или закупается отдельно?', required:true, options:['Входит','Отдельно','Не знаю']},
  {id:'install', section:'C2 ОСОБЕННОСТИ', text:'Стационарная или переносная установка?', required:true, options:['Стационарная','Переносная']},
  {id:'offline', section:'C2 ОСОБЕННОСТИ', text:'Нужно офлайн-работать без интернета? (да/нет)', required:true, options:['Да','Нет']},
  {id:'devices', section:'C2 ОСОБЕННОСТИ', text:'Нужна адаптация под разные устройства?', required:true, options:['Да','Нет','Возможно']},
  {id:'cast', section:'C2 ОСОБЕННОСТИ', text:'Нужна трансляция на экран/проектор? (да/нет)', required:true, options:['Да','Нет']},
  {id:'metrics', section:'C3 ИНТЕГРАЦИИ', text:'Собирать аналитику использования? (да/нет)', required:true, options:['Да','Нет']},
  {id:'integrations', section:'C3 ИНТЕГРАЦИИ', text:'Интеграции (CRM/сайт/другое)?', required:false},
  {id:'admin', section:'C3 ИНТЕГРАЦИИ', text:'Нужна админ-панель для изменения контента? (да/нет)', required:true, options:['Да','Нет']},
  {id:'bizgoal', section:'D1 ЦЕЛЬ', text:'Бизнес-задача (продажи/обучение/профориентация/PR/образование/другое)', required:true},
  {id:'kpi', section:'D2 МЕТРИКИ', text:'Как измерять успех? (конкретные метрики)', required:true},
  {id:'gamify', section:'E1 ДОП', text:'Геймификация (баллы/награды)?', required:false, options:['Да','Нет']},
  {id:'quiz', section:'E1 ДОП', text:'Викторины/тесты?', required:false, options:['Да','Нет']},
  {id:'leaderboard', section:'E1 ДОП', text:'Таблица лидеров?', required:false, options:['Да','Нет']},
  {id:'scaling', section:'E2 ДОП', text:'Масштабирование контента?', required:false, options:['Часто','Редко','Нет']},
  {id:'other', section:'E2 ДОП', text:'Дополнительно — что важно учесть? (свободный текст)', required:false},
];
const REQUIRED_IDS = QUESTIONS.filter(q=>q.required).map(q=>q.id);

const VARIANT_SETS = {
  deadline:['2 недели','1 месяц','2 месяца','3 месяца','Квартал (Q1/Q2)','Полугодие'],
  budget:['до 300 000 ₽','300–800 тыс. ₽','0,8–1,5 млн ₽','1,5–3 млн ₽','3–7 млн ₽','> 7 млн ₽','Не определён']
};
const NA_VALUES = new Set(['нет информации','n/a','не известно','неизвестно','позже','—','-']);

/* ========= СОСТОЯНИЕ ========= */
const state = { idx:-1, answers:{}, filesForm:[] };

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ========= UI хелперы ========= */
function addMsg(role, text, typing=false){
  const wrap = $('#chat');
  if (typing){
    const t = document.createElement('div');
    t.className = 'typing msg bot';
    t.innerHTML = '<i></i><i></i><i></i>';
    wrap.appendChild(t);
    wrap.scrollTop = wrap.scrollHeight;
    setTimeout(()=>{ t.remove(); addMsg(role,text,false); }, 350);
    return;
  }
  const div = document.createElement('div');
  div.className = 'msg ' + (role==='bot'?'bot':'user');
  div.textContent = text;
  wrap.appendChild(div);
  wrap.scrollTop = wrap.scrollHeight;
}
function setProgress(){
  const provided = REQUIRED_IDS.filter(id => {
    const v = (state.answers[id]||'').trim().toLowerCase();
    return v && !NA_VALUES.has(v);
  }).length;
  const total = REQUIRED_IDS.length;
  const pct = total ? Math.round(provided/total*100) : 0;
  $('#filledCount').textContent = provided;
  $('#reqCount').textContent = total;
  $('#filledPct').textContent = pct + '%';
  $('#bar').style.width = pct + '%';
}
function filePills(node, files){
  node.innerHTML='';
  files.forEach(f=>{
    const d = document.createElement('div');
    d.className='filepill';
    d.textContent = f.name + ' (' + Math.round(f.size/1024) + ' КБ)';
    node.appendChild(d);
  });
}

/* ========= Чипы быстрых ответов ========= */
function addChip(txt, cls=''){
  const c = document.createElement('div');
  c.className = 'chip ' + cls;
  c.textContent = txt;
  c.addEventListener('click', ()=>{ $('#answer').value = txt; submitAnswer(); });
  $('#quick').appendChild(c);
}
function addVariantsButton(id){
  const btn = document.createElement('div');
  btn.className = 'chip suggest';
  btn.textContent = 'Предложить варианты';
  btn.title = 'Показать типовые диапазоны';
  btn.addEventListener('click', ()=>{
    const arr = VARIANT_SETS[id] || [];
    arr.forEach(v=> addChip(v));
    btn.remove();
  });
  $('#quick').appendChild(btn);
}

/* ========= Навигация по вопросам ========= */
function showQuestion(i){
  state.idx = i;
  const q = QUESTIONS[i];
  if (!q) return;
  $('#curBlock').textContent = q.section;
  $('#curQ').textContent = q.text;
  $('#quick').innerHTML = '';
  addMsg('bot', q.text, true);

  // предопределённые опции
  if (q.options){ q.options.forEach(opt=> addChip(opt)); }
  // кнопка «Предложить варианты» для сроков/бюджета
  if (q.variantsBtn){ addVariantsButton(q.id); }
  // универсальные чипы
  addChip('Нет информации','ghost');
  addChip('Введу вручную','ghost');

  setProgress();
}
function submitAnswer(){
  const q = QUESTIONS[state.idx];
  const val = ($('#answer').value||'').trim();
  if (!q) return;
  addMsg('user', val.length?val:'—');
  state.answers[q.id] = val || '';
  $('#answer').value = '';
  $('#quick').innerHTML = '';
  const next = state.idx + 1;
  if (next < QUESTIONS.length) showQuestion(next);
  else addMsg('bot','Вопросы закончились. Нажмите «Сформировать итог».', true);
  setProgress();
}
function prev(){ const p = Math.max(0, state.idx-1); showQuestion(p); }
function skip(){ const q = QUESTIONS[state.idx]; state.answers[q.id] = ''; addMsg('user','(пропущено)'); showQuestion(state.idx+1); }

/* ========= Итоговый текст ========= */
function percentReport(missing){
  const total = REQUIRED_IDS.length, miss = missing.length, have = total-miss;
  return {pct: total?Math.round(have/total*100):0, have, miss, total};
}
function isMissing(id){
  const v = (state.answers[id]||'').trim();
  return !v || NA_VALUES.has(v.toLowerCase());
}
function buildFollowup(missingIds){
  if (!missingIds.length) return 'Все обязательные сведения получены.';
  const MAP = {
    client:'Подскажите, кто заказчик (индустрия/размер/специфика)?',
    problem:'Сформулируйте главную проблему проекта (1–2 предложения).',
    deadline:'Какой крайний срок/когда должен быть результат?',
    budget:'Есть ли ориентир по бюджету или диапазон?',
    platform:'На какой платформе хотите запуск (VR/AR/веб/моб/киоск)?',
    audience:'Кто конечные пользователи (возраст/сфера/подготовка)?',
    users:'Сколько пользователей: 1 / группа / массово?',
    place:'Где будут использовать: офис/выставка/дом/улица?',
    script_ready:'Есть ли материалы по сценарию/ТЗ?',
    duration:'Сколько минут длится пользовательский опыт?',
    interaction:'Какой тип: пассивный/активный/обучение/комбинация?',
    assets:'Есть 3D-модели? Пришлите, если да.',
    texts:'Есть тексты/описания? Нужна ли помощь?',
    voice:'Нужна ли дикторская озвучка?',
    quality:'Желаемый уровень графики?',
    gear:'Есть ли VR/AR-оборудование у клиента? Какое?',
    gear_count:'Сколько комплектов нужно?',
    gear_budget:'Оборудование в бюджете проекта или отдельно?',
    install:'Стационарная или переносная установка?',
    offline:'Нужна офлайн-работа без интернета?',
    devices:'Нужна адаптация под разные устройства?',
    cast:'Нужна трансляция на экран/проектор?',
    metrics:'Собирать аналитику использования?',
    admin:'Нужна админ-панель?',
    bizgoal:'Какая бизнес-задача в приоритете?',
    kpi:'Какими метриками измерять успех?'
  };
  return missingIds.map((id,i)=> (i+1)+'. '+(MAP[id]||('Уточните: '+id))).join('\n');
}
function buildFormFinalText(){
  const missing = REQUIRED_IDS.filter(isMissing);
  const rep = percentReport(missing);
  let out = '';
  out += '# Сводка (цитаты)\n— Сформировано: '+new Date().toLocaleString()+'\n\n';
  let cur = '';
  QUESTIONS.forEach(q=>{
    if (q.section!==cur){ cur=q.section; out+='## '+q.section+'\n'; }
    const a = (state.answers[q.id]||'').trim();
    out += '• '+q.text+'\n  → '+(a ? '«'+a+'»' : '—')+'\n';
  });
  out += '\n# Вложения\n';
  out += (state.filesForm.length? state.filesForm.map((f,i)=> (i+1)+'. '+f.name+' ('+Math.round(f.size/1024)+' КБ)').join('\n') : '—')+'\n';
  out += '\n# Оценка полноты\n';
  out += 'Заполнено: '+rep.pct+'% ('+rep.have+'/'+rep.total+').\n';
  out += 'Не хватает: '+(100-rep.pct)+'% ('+rep.miss+'/'+rep.total+').\n';
  out += '\n# Критические пробелы (отмечены как «Нет информации» или пустые)\n';
  out += (missing.length? missing.map((id,i)=> (i+1)+'. '+(QUESTIONS.find(x=>x.id===id)?.text||id)).join('\n') : 'Нет')+'\n';
  out += '\n# Скрипт вопросов для созвона\n'+buildFollowup(missing)+'\n';
  out += '\n# Примечание\nТекст выше — только ваши цитаты; заголовки добавлены для структуры.\n';
  return {text:out, percent:rep.pct};
}

/* ========= ZIP ========= */
async function zipForm(){
  const zip=new JSZip();
  const {text}=buildFormFinalText();
  zip.file('summary.txt',text);
  zip.file('data.json',JSON.stringify({answers:state.answers},null,2));
  if(state.filesForm.length){
    const folder=zip.folder('attachments');
    for(const f of state.filesForm){ const arr=await f.arrayBuffer(); folder.file(f.name,arr); }
  }
  const blob=await zip.generateAsync({type:'blob'}); saveAs(blob,'kp_form_package.zip');
}

/* ========= ИНИЦ-ФОРМА ========= */
function initForm(){
  addMsg('bot','Привет! Я соберу сведения для КП. Отвечайте чипами или вводом, для любого пункта доступно «Нет информации».',true);
  showQuestion(0); setProgress();
}

/* ========= АНАЛИЗ ФАЙЛОВ ========= */
const analysis={files:[],extracted:''};
function renderFiles(node,files){ node.innerHTML=''; files.forEach(f=>{ const d=document.createElement('div'); d.className='filepill'; d.textContent=f.name+' ('+Math.round(f.size/1024)+' КБ)'; node.appendChild(d); }); }
function readAsText(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onerror=()=>rej(new Error('read error')); r.onload=()=>res(r.result); r.readAsText(file); });}
function readAsAB(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onerror=()=>rej(new Error('ab error')); r.onload=()=>res(r.result); r.readAsArrayBuffer(file); });}
async function extractFromPDF(file){ const data=await readAsAB(file); const pdf=await pdfjsLib.getDocument({data}).promise; let full=''; for(let p=1;p<=pdf.numPages;p++){ const page=await pdf.getPage(p); const content=await page.getTextContent(); full+=content.items.map(i=>i.str).join(' ')+'\n'; } return full; }
async function extractFromDOCX(file){ const data=await readAsAB(file); const res=await window.mammoth.extractRawText({arrayBuffer:data}); return res.value||''; }
async function extractText(files){
  let all=''; for(const f of files){ const type=f.type||''; try{
      if(type.includes('pdf')||/\.pdf$/i.test(f.name)){ all+='\n\n===== '+f.name+' (PDF) =====\n'+(await extractFromPDF(f)).trim(); }
      else if(type.includes('word')||/\.docx$/i.test(f.name)){ all+='\n\n===== '+f.name+' (DOCX) =====\n'+(await extractFromDOCX(f)).trim(); }
      else if(type.startsWith('text')||/\.(txt|md|csv|log)$/i.test(f.name)){ all+='\n\n===== '+f.name+' (TEXT) =====\n'+(await readAsText(f)||'').trim(); }
      else { all+='\n\n===== '+f.name+' (не извлечено) =====\n[Тип не поддержан — файл будет приложен в архив]'; }
    }catch(e){ all+='\n\n===== '+f.name+' (ошибка) =====\n[Не удалось извлечь текст: '+e.message+']'; }
  } return all.trim();
}
function coverageHeuristics(text){
  text=(text||'').toLowerCase(); const hits=new Set();
  const pats=[['client',/(клиент|заказчик|компан|организац)/],['problem',/(проблем|pain|задач)/],
    ['deadline',/(срок|дедлайн|крайн)/],['budget',/(бюджет|стоимост|инвестиц)/],
    ['platform',/\b(vr|ar|web|веб|мобильн|киоск|панел)/],['audience',/(аудитори|пользовател|учащ|сотрудник|посетител)/],
    ['users',/(количеств|пользоват|массов|групп)/],['place',/(офис|выставк|дом|улиц|площад|школ|университ)/],
    ['script_ready',/(сценар|тз|бриф|описан)/],['duration',/(минут|длит|сеанс)/],
    ['interaction',/(обучени|тест|геймпле|интерак|пассивн|активн)/],
    ['assets',/(3d|модель|ассет|cad|fbx|obj)/],['texts',/(текст|контент|описан)/],
    ['voice',/(озвуч|диктор|аудио|звук)/],['quality',/(фотореал|реалист|стилиз|простая графика)/],
    ['gear',/(pico|quest|meta|vive|hololens|оборудов)/],['gear_count',/(комплект|шлем|устройств)/],
    ['gear_budget',/(закупк|бюджет оборуд)/],['install',/(стационарн|переносн)/],
    ['offline',/(офлайн|без интернета|автоном)/],['devices',/(кроссплатформ|android|ios|pc|windows|mac)/],
    ['cast',/(трансляц|на экран|tv|проектор)/],['metrics',/(аналитик|метрик|kpi)/],
    ['admin',/(админ|cms|редакт)/],['bizgoal',/(продаж|обучен|профориентац|маркетинг|pr|образован)/],
    ['kpi',/(roi|рост|сокращен|процент|конверси)/] ];
  pats.forEach(([id,rx])=> rx.test(text)&&hits.add(id));
  return [...hits];
}
function conceptDraftFrom(text){
  const vr=/\bvr\b|виртуал/i.test(text), ar=/\bar\b|допол/i.test(text), web=/web|веб/i.test(text);
  const platform= vr?'VR': ar?'AR': web?'Веб':'Определить на созвоне';
  const deadline=(text.match(/(\d{1,2}\.\d{1,2}\.\d{2,4}|Q[1-4]\s?\d{4}|[Яя]нвар|[Фф]еврал|Март|Апрел|Май|Июн|Июл|Август|Сентябр|Октябр|Ноябр|Декабр)/g)||[]).slice(0,2).join(', ')||'Не указано';
  const budget=(text.match(/(\d[\d\s]{2,})(?:\s?(?:₽|руб|rubl|RUB|USD|EUR))/gi)||[])[0]||'Не указан';
  let d='Название: Концепция '+platform+'-решения (черновик)\n';
  d+='Платформа: '+platform+'\nОриентир по срокам: '+deadline+'\nОриентир по инвестициям: '+budget+'\n\n';
  d+='Ключевые цитаты:\n';
  const s=(text||'').split(/[\.\!\?]\s+/).filter(s=>s.length>50&&s.length<300).slice(0,3);
  d+= s.length? s.map(x=>'— «'+x.trim()+'»').join('\n') : '— (нужно уточнить на созвоне)';
  d+='\n\nСтруктура КП (черновик):\n1) Заголовок → результат.\n2) Понимание ситуации (цитаты).\n3) Концепция без техножаргона.\n4) Путь пользователя.\n5) 2–3 варианта.\n6) Доказательства/кейсы.\n7) Инвестиции и сроки.\n8) Следующий шаг.';
  d+='\n\nПримечание: блок — конструктор, не цитаты.'; return d;
}
function filesOutputs(extracted){
  const hits=coverageHeuristics(extracted);
  const missing=REQUIRED_IDS.filter(id=>!hits.includes(id));
  const rep={pct: Math.round((REQUIRED_IDS.length-missing.length)/REQUIRED_IDS.length*100), have:0, miss:0, total:0};
  const haveList = hits.map(id=>'• '+(QUESTIONS.find(x=>x.id===id)?.text||id)).join('\n')||'—';
  const missList = missing.map(id=>'• '+(QUESTIONS.find(x=>x.id===id)?.text||id)).join('\n')||'—';
  const script = buildFollowup(missing);
  const concept = conceptDraftFrom(extracted);
  return {rep,haveList,missList,script,concept};
}
async function zipFiles(){
  const zip=new JSZip();
  zip.file('extracted_quotes.txt',$('#extractedText').value||'');
  zip.file('concept_draft.txt',$('#concept').value||'');
  if(analysis.files.length){
    const folder=zip.folder('attachments');
    for(const f of analysis.files){ const arr=await f.arrayBuffer(); folder.file(f.name,arr); }
  }
  const blob=await zip.generateAsync({type:'blob'}); saveAs(blob,'kp_analysis_package.zip');
}

/* ========= BINDINGS ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  // Tabs
  $$('.tab').forEach(t=> t.addEventListener('click',()=>{
    $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    $$('.panel').forEach(p=>p.classList.remove('active'));
    (t.dataset.tab==='form'? $('#panel-form'): $('#panel-files')).classList.add('active');
  }));

  // Form/Chat
  $('#send').addEventListener('click', submitAnswer);
  $('#answer').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); submitAnswer(); } });
  $('#prev').addEventListener('click', prev);
  $('#skip').addEventListener('click', skip);
  $('#finish').addEventListener('click', ()=>{ const {text}=buildFormFinalText(); $('#finalTextForm').value=text; addMsg('bot','Итог сформирован ниже. Можно скачать ZIP.',true); });
  $('#reset').addEventListener('click', ()=>{
    state.idx=-1; state.answers={}; state.filesForm=[]; $('#chat').innerHTML=''; $('#finalTextForm').value='';
    $('#fileListForm').innerHTML=''; $('#curBlock').textContent='–'; $('#curQ').textContent='–';
    $('#bar').style.width='0%'; $('#filledPct').textContent='0%'; $('#filledCount').textContent='0';
    $('#reqCount').textContent=REQUIRED_IDS.length; initForm();
  });
  $('#copyForm').addEventListener('click', ()=> navigator.clipboard.writeText($('#finalTextForm').value||''));
  $('#zipForm').addEventListener('click', zipForm);
  $('#fileInputForm').addEventListener('change', e=>{
    const files=[...(e.target.files||[])]; state.filesForm.push(...files);
    filePills($('#fileListForm'), state.filesForm); addMsg('bot', `Файлов добавлено: ${files.length}. Они попадут в архив.`, true); e.target.value='';
  });
  $('#reqCount').textContent = REQUIRED_IDS.length;
  initForm();

  // Files analysis
  $('#fileInputAnalysis').addEventListener('change', e=>{ analysis.files=[...(e.target.files||[])]; renderFiles($('#fileListAnalysis'),analysis.files); });
  $('#analyze').addEventListener('click', async ()=>{
    if(!analysis.files.length){ alert('Загрузите хотя бы один файл.'); return; }
    $('#extractedText').value='Извлечение…';
    const text=await extractText(analysis.files); analysis.extracted=text;
    $('#extractedText').value=text||'(текст не найден)';
    const out=filesOutputs(text);
    $('#covPct').textContent=out.rep.pct+'%';
    $('#covHave').textContent=out.haveList;
    $('#covMiss').textContent=out.missList;
    $('#callScript').textContent=out.script;
    $('#concept').value=out.concept;
  });
  $('#copyFiles').addEventListener('click', ()=>{
    const full=['# Извлечённые цитаты', $('#extractedText').value,'','# Оценка полноты','Покрытие: '+$('#covPct').textContent,'Хватает:\n'+$('#covHave').textContent,'Не хватает:\n'+$('#covMiss').textContent,'','# Скрипт вопросов',$('#callScript').textContent,'','# Черновик концепции КП',$('#concept').value].join('\n');
    navigator.clipboard.writeText(full);
  });
  $('#zipFiles').addEventListener('click', zipFiles);
});
</script>
</body>
</html>
