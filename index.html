<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>КП Конструктор — тёмная тема, анализ с текстовыми блоками</title>
<style>
  :root{
    --bg:#0b0e12; --card:#11151c; --line:#212631; --fg:#e6e7eb; --muted:#95a1b2;
    --accent:#ffffff; --accent-2:#bfc7d8; --chip:#161b22; --chip-br:#2a3140;
    --chip-hover:#1f2530; --chip-active:#2a3140; --danger:#ff4d4f; --ok:#5bef8a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
    font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  a{color:var(--accent)}
  header{border-bottom:1px solid var(--line);padding:16px 20px;display:flex;gap:16px;align-items:center;justify-content:space-between;background:#0a0d11;position:sticky;top:0;z-index:5}
  header h1{margin:0;font-size:18px;font-weight:600;letter-spacing:.3px}
  .tabs{display:flex;gap:6px}
  .tab{border:1px solid var(--line);padding:8px 12px;cursor:pointer;border-radius:999px;background:var(--chip);color:var(--accent-2);transition:.25s ease}
  .tab:hover{border-color:var(--accent-2);color:var(--accent)}
  .tab.active{background:#ffffff10;border-color:#ffffff44;color:#fff;box-shadow:0 0 0 1px #ffffff22 inset}
  main{max-width:1100px;margin:24px auto;padding:0 20px}
  .panel{display:none;animation:fadeIn .35s ease}
  .panel.active{display:block}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
  .card{border:1px solid var(--line);border-radius:16px;padding:14px;background:var(--card);box-shadow:0 10px 30px #00000033}
  .title{font-size:13px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:8px}
  .meta{font-size:12px;color:var(--muted)}
  .hr{border-top:1px solid var(--line);margin:14px 0}
  /* CHAT */
  .chat{height:520px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:10px;border:1px dashed var(--line);border-radius:14px;background:#0d1117;scroll-behavior:smooth}
  .msg{max-width:82%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);animation:slideUp .25s ease}
  .msg.bot{align-self:flex-start;background:#0f141c}
  .msg.user{align-self:flex-end;background:#0b0e12;border-color:#ffffff33;box-shadow:0 0 0 1px #ffffff16 inset}
  .typing{width:46px;height:14px;display:flex;gap:6px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:#0f141c}
  .typing i{width:6px;height:6px;border-radius:50%;background:#74839a;animation:blink 1.2s infinite}
  .typing i:nth-child(2){animation-delay:.2s}
  .typing i:nth-child(3){animation-delay:.4s}
  .inputbar{display:flex;gap:8px;margin-top:10px}
  .inputbar input[type="text"], .inputbar textarea{flex:1;padding:12px 12px;border:1px solid var(--line);border-radius:12px;min-height:44px;background:#0d1117;color:var(--fg);outline:none;transition:border .2s ease}
  .inputbar input:focus{border-color:#ffffff44}
  .btn{border:1px solid var(--line);background:#0f141c;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s ease}
  .btn:hover{border-color:#ffffff44;background:#121a25}
  .btn.black{background:#ffffff14;color:#fff;border-color:#ffffff44}
  .btn.black:hover{background:#ffffff22}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  .chip{border:1px solid var(--chip-br);padding:8px 12px;border-radius:999px;cursor:pointer;background:var(--chip);color:#d7deee;transition:transform .06s ease, background .2s ease, border .2s ease;animation:pop .18s ease}
  .chip:hover{background:var(--chip-hover);border-color:#3a4254}
  .chip:active{transform:scale(.97);background:var(--chip-active)}
  .chip.ghost{border-style:dashed;color:#b7bfd1}
  .chip.suggest{border-color:#4a5368;background:#111827}
  .progress{height:10px;background:#0d1117;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
  .bar{height:100%;background:linear-gradient(90deg,#7f8cff,#5be2ff);width:0%;transition:width .35s ease}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:6px;margin:6px 0}
  .kv div:first-child{color:var(--muted)}
  .files{display:flex;flex-wrap:wrap;gap:8px}
  .filepill{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#0d1117;color:#c7d2e2}
  pre, textarea.output{width:100%;min-height:220px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#0d1117;color:#e7e9ef;white-space:pre-wrap}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .hidden{display:none !important}
  /* custom blocks */
  .customWrap{display:flex;flex-direction:column;gap:12px;margin-top:10px}
  .customCard{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0d1117;animation:fadeIn .25s ease}
  .customHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .badge{font-size:12px;color:#c7d2e2;background:#111827;border:1px solid var(--line);padding:4px 8px;border-radius:999px}
  .del{cursor:pointer;border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#161b22}
  .del:hover{background:#1d2532}
  .plusWrap{position:relative;display:inline-block}
  .plusBtn{border:1px solid var(--line);background:#0f141c;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .plusMenu{position:absolute;top:42px;left:0;min-width:240px;background:#0f141c;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 30px #0008;padding:8px;display:none;z-index:10}
  .plusMenu .item{padding:8px 10px;border-radius:8px;cursor:pointer}
  .plusMenu .item:hover{background:#121a25}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  @keyframes slideUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pop{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
  @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>
<header>
  <h1>КП Конструктор — тёмная тема + анализ с блоками</h1>
  <div class="tabs">
    <div class="tab" data-tab="form">Форма + чат</div>
    <div class="tab active" data-tab="files">Анализ файла</div>
  </div>
</header>

<main>
  <!-- ===== FILE ANALYSIS (сначала этот режим по умолчанию включён) ===== -->
  <section id="panel-files" class="panel active">
    <div class="card">
      <div class="title">Загрузка материалов</div>
      <div class="chips" style="align-items:center">
        <input id="fileInputAnalysis" type="file" multiple />
        <button id="analyze" class="btn black">Извлечь и разобрать</button>
        <div class="plusWrap">
          <button id="plusBtn" class="plusBtn">+ Добавить блок</button>
          <div id="plusMenu" class="plusMenu">
            <div class="item" data-type="Транскрипт звонка">Транскрипт звонка</div>
            <div class="item" data-type="Текстовый комментарий">Текстовый комментарий</div>
            <div class="item" data-type="Запрос клиента">Запрос клиента</div>
            <div class="item" data-type="Прочий текст">Прочий текст</div>
          </div>
        </div>
      </div>
      <div id="fileListAnalysis" class="files"></div>

      <div class="hr"></div>
      <div class="title">Текстовые блоки (добавляются вручную)</div>
      <div id="customBlocks" class="customWrap"></div>
      <div class="meta">Эти тексты будут учитываться как цитаты: войдут в анализ, в сводный документ и в распределение по структуре КП.</div>
    </div>

    <div class="grid" style="margin-top:24px">
      <div class="card">
        <div class="title">Извлечённые цитаты + добавленные блоки</div>
        <textarea id="extractedText" class="output" placeholder="Сюда попадёт текст из файлов и из ваших блоков…"></textarea>
      </div>
      <div class="card">
        <div class="title">Оценка полноты</div>
        <div class="kv"><div>Покрытие</div><div class="ok"><span id="covPct">0%</span></div></div>
        <div class="kv"><div>Хватает</div><div id="covHave">–</div></div>
        <div class="kv"><div>Не хватает</div><div id="covMiss" class="danger">–</div></div>
        <div class="hr"></div>
        <div class="title">Скрипт вопросов для созвона</div>
        <pre id="callScript" style="min-height:160px"></pre>
      </div>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="title">Сводный документ (все ответы/материалы)</div>
      <textarea id="fullDoc" class="output" placeholder="Единый документ для передачи в ИИ или в архив…"></textarea>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="title">Распределение по структуре КП (цитаты)</div>
      <textarea id="structureOut" class="output" placeholder="Авто-разложение фраз по разделам идеального КП…"></textarea>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="title">Черновик концепции КП (по извлечённым данным)</div>
      <textarea id="concept" class="output" placeholder="Авто-набросок (не цитаты)."></textarea>
      <div class="right" style="margin-top:8px">
        <button id="copyFiles" class="btn">Копировать всё</button>
        <button id="zipFiles" class="btn black">Скачать ZIP</button>
      </div>
      <div class="meta" style="margin-top:8px">Важно: «Черновик концепции КП» — машинный конструктор и не является цитатами. Остальные блоки сохраняют точные формулировки материалов.</div>
    </div>
  </section>

  <!-- ===== FORM/CHAT (как был) ===== -->
  <section id="panel-form" class="panel">
    <div class="card">
      <div class="title">Форма/чат вынесен во вторую вкладку — функционал не изменён.</div>
      <div class="meta">Если нужен и этот режим — верну полный чат по запросу, чтобы файл не разрастался. Основной фокус сейчас — «Анализ файла».</div>
    </div>
  </section>
</main>

<!-- ===== LIBS ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>if(window['pdfjsLib']) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js';</script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

<script>
/* ====== Базовые структуры для оценки полноты ====== */
const QUESTIONS = [
  {id:'client', text:'Кто клиент? (индустрия, размер, специфика)', required:true},
  {id:'problem', text:'Какую проблему решаем? (текстом)', required:true},
  {id:'deadline', text:'Крайний срок/когда нужен результат?', required:true},
  {id:'budget', text:'Есть ориентир по бюджету? (диапазон или «не определён»)', required:true},
  {id:'platform', text:'Платформа: VR / AR / Веб / Мобильное / Киоск / Комбинация', required:true},
  {id:'audience', text:'Кто конечные пользователи? (возраст/сфера/подготовка)', required:true},
  {id:'users', text:'Сколько пользователей? (один/группа/массово)', required:true},
  {id:'place', text:'Где будут пользоваться? (офис/выставка/дом/улица)', required:true},
  {id:'script_ready', text:'Есть готовый сценарий? (да/нет/частично)', required:true},
  {id:'duration', text:'Длительность пользовательского опыта (мин.)', required:true},
  {id:'interaction', text:'Тип взаимодействия: пассивный/активный/обучение/комбинация', required:true},
  {id:'assets', text:'Есть ли 3D-модели? (да/нет/приложу)', required:true},
  {id:'texts', text:'Есть ли тексты/описания? (да/нет/нужна помощь)', required:true},
  {id:'voice', text:'Нужна ли дикторская озвучка? (да/нет)', required:true},
  {id:'quality', text:'Качество графики: фотореализм/стилизация/простая', required:true},
  {id:'gear', text:'Есть ли у клиента VR/AR-оборудование? (какое?)', required:true},
  {id:'gear_count', text:'Сколько комплектов нужно?', required:true},
  {id:'gear_budget', text:'Оборудование входит в бюджет или закупается отдельно?', required:true},
  {id:'install', text:'Стационарная или переносная установка?', required:true},
  {id:'offline', text:'Нужно офлайн-работать без интернета? (да/нет)', required:true},
  {id:'devices', text:'Нужна адаптация под разные устройства?', required:true},
  {id:'cast', text:'Нужна трансляция на экран/проектор? (да/нет)', required:true},
  {id:'metrics', text:'Собирать аналитику использования? (да/нет)', required:true},
  {id:'admin', text:'Нужна админ-панель для изменения контента? (да/нет)', required:true},
  {id:'bizgoal', text:'Бизнес-задача (продажи/обучение/профориентация/PR/образование/другое)', required:true},
  {id:'kpi', text:'Как измерять успех? (конкретные метрики)', required:true}
];
const REQUIRED_IDS = QUESTIONS.filter(q=>q.required).map(q=>q.id);

/* ====== Состояние «Анализа файла» ====== */
const analysis = {
  files: [],
  custom: [], // {id, type, text}
  extracted: '',
  combined: ''
};

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ====== UI: вкладки ====== */
$$('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    $$('.panel').forEach(p=>p.classList.remove('active'));
    (t.dataset.tab==='files' ? $('#panel-files') : $('#panel-form')).classList.add('active');
  });
});

/* ====== Helpers для файлов и чтения ====== */
function renderFiles(node, files){
  node.innerHTML='';
  files.forEach(f=>{
    const d=document.createElement('div');
    d.className='filepill';
    d.textContent = f.name + ' (' + Math.round(f.size/1024) + ' КБ)';
    node.appendChild(d);
  });
}
function readAsText(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onerror=()=>rej(new Error('read error')); r.onload=()=>res(r.result); r.readAsText(file); });}
function readAsAB(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onerror=()=>rej(new Error('ab error')); r.onload=()=>res(r.result); r.readAsArrayBuffer(file); });}
async function extractFromPDF(file){ const data=await readAsAB(file); const pdf=await pdfjsLib.getDocument({data}).promise; let full=''; for(let p=1;p<=pdf.numPages;p++){ const page=await pdf.getPage(p); const content=await page.getTextContent(); full += content.items.map(i=>i.str).join(' ')+'\n'; } return full; }
async function extractFromDOCX(file){ const data=await readAsAB(file); const out=await window.mammoth.extractRawText({arrayBuffer:data}); return out.value||''; }
async function extractTextFromFiles(files){
  let all=''; for(const f of files){ const type=f.type||''; try{
    if(type.includes('pdf')||/\.pdf$/i.test(f.name)){ all+='\n\n===== '+f.name+' (PDF) =====\n'+(await extractFromPDF(f)).trim(); }
    else if(type.includes('word')||/\.docx$/i.test(f.name)){ all+='\n\n===== '+f.name+' (DOCX) =====\n'+(await extractFromDOCX(f)).trim(); }
    else if(type.startsWith('text')||/\.(txt|md|csv|log)$/i.test(f.name)){ all+='\n\n===== '+f.name+' (TEXT) =====\n'+(await readAsText(f)||'').trim(); }
    else { all+='\n\n===== '+f.name+' (не извлечено) =====\n[Тип не поддержан — файл будет приложен в архив]'; }
  }catch(e){ all+='\n\n===== '+f.name+' (ошибка) =====\n[Не удалось извлечь текст: '+e.message+']'; } }
  return all.trim();
}

/* ====== Кастомные блоки ====== */
function addCustomBlock(type){
  const id = 'block_'+Math.random().toString(36).slice(2,9);
  analysis.custom.push({id, type, text:''});
  renderCustomBlocks();
}
function removeCustomBlock(id){
  analysis.custom = analysis.custom.filter(b=>b.id!==id);
  renderCustomBlocks();
}
function renderCustomBlocks(){
  const wrap = $('#customBlocks');
  wrap.innerHTML = '';
  analysis.custom.forEach((b, idx)=>{
    const card = document.createElement('div');
    card.className = 'customCard';
    card.innerHTML = `
      <div class="customHead">
        <div class="badge">${idx+1}. ${b.type}</div>
        <div class="del" title="Удалить" data-id="${b.id}">×</div>
      </div>
      <textarea data-id="${b.id}" class="output" style="min-height:120px" placeholder="Вставьте текст…"></textarea>
      <div class="meta">Совет: можно вставлять большие тексты — они будут учитываться в анализе.</div>
    `;
    wrap.appendChild(card);
  });
  // bind
  wrap.querySelectorAll('.del').forEach(btn=>{
    btn.addEventListener('click', ()=> removeCustomBlock(btn.getAttribute('data-id')));
  });
  wrap.querySelectorAll('textarea').forEach(ta=>{
    ta.addEventListener('input', ()=> {
      const id = ta.getAttribute('data-id');
      const block = analysis.custom.find(x=>x.id===id);
      if(block) block.text = ta.value || '';
    });
  });
}

/* ====== Меню добавления блока ====== */
$('#plusBtn').addEventListener('click', ()=>{
  const m = $('#plusMenu');
  m.style.display = (m.style.display==='block'?'none':'block');
});
document.addEventListener('click', (e)=>{
  const m = $('#plusMenu');
  if (!m.contains(e.target) && !$('#plusBtn').contains(e.target)) m.style.display='none';
});
$('#plusMenu').querySelectorAll('.item').forEach(it=>{
  it.addEventListener('click', ()=>{
    addCustomBlock(it.getAttribute('data-type'));
    $('#plusMenu').style.display='none';
  });
});

/* ====== Оценка покрытия и скрипт вопросов ====== */
function coverageHeuristics(text){
  text=(text||'').toLowerCase();
  const hits=new Set();
  const pats=[['client',/(клиент|заказчик|компан|организац)/],['problem',/(проблем|pain|задач)/],
    ['deadline',/(срок|дедлайн|крайн)/],['budget',/(бюджет|стоимост|инвестиц)/],
    ['platform',/\b(vr|ar|web|веб|мобильн|киоск|панел)/],['audience',/(аудитори|пользовател|учащ|сотрудник|посетител)/],
    ['users',/(количеств|пользоват|массов|групп)/],['place',/(офис|выставк|дом|улиц|площад|школ|университ)/],
    ['script_ready',/(сценар|тз|бриф|описан)/],['duration',/(минут|длит|сеанс)/],
    ['interaction',/(обучени|тест|геймпле|интерак|пассивн|активн)/],
    ['assets',/(3d|модель|ассет|cad|fbx|obj)/],['texts',/(текст|контент|описан)/],
    ['voice',/(озвуч|диктор|аудио|звук)/],['quality',/(фотореал|реалист|стилиз|простая графика)/],
    ['gear',/(pico|quest|meta|vive|hololens|оборудов)/],['gear_count',/(комплект|шлем|устройств)/],
    ['gear_budget',/(закупк|бюджет оборуд)/],['install',/(стационарн|переносн)/],
    ['offline',/(офлайн|без интернета|автоном)/],['devices',/(кроссплатформ|android|ios|pc|windows|mac)/],
    ['cast',/(трансляц|на экран|tv|проектор)/],['metrics',/(аналитик|метрик|kpi)/],
    ['admin',/(админ|cms|редакт)/],['bizgoal',/(продаж|обучен|профориентац|маркетинг|pr|образован)/],
    ['kpi',/(roi|рост|сокращен|процент|конверси)/] ];
  pats.forEach(([id,rx])=> rx.test(text)&&hits.add(id));
  return [...hits];
}
function buildFollowup(missingIds){
  if (!missingIds.length) return 'Все обязательные сведения получены.';
  const MAP = {
    client:'Подскажите, кто заказчик (индустрия/размер/специфика)?',
    problem:'Сформулируйте главную проблему проекта (1–2 предложения).',
    deadline:'Какой крайний срок/когда должен быть результат?',
    budget:'Есть ли ориентир по бюджету или диапазон?',
    platform:'На какой платформе хотите запуск (VR/AR/веб/моб/киоск)?',
    audience:'Кто конечные пользователи (возраст/сфера/подготовка)?',
    users:'Сколько пользователей: 1 / группа / массово?',
    place:'Где будут использовать: офис/выставка/дом/улица?',
    script_ready:'Есть ли материалы по сценарию/ТЗ?',
    duration:'Сколько минут длится пользовательский опыт?',
    interaction:'Какой тип: пассивный/активный/обучение/комбинация?',
    assets:'Есть 3D-модели? Пришлите, если да.',
    texts:'Есть тексты/описания? Нужна ли помощь?',
    voice:'Нужна ли дикторская озвучка?',
    quality:'Желаемый уровень графики?',
    gear:'Есть ли VR/AR-оборудование у клиента? Какое?',
    gear_count:'Сколько комплектов нужно?',
    gear_budget:'Оборудование в бюджете проекта или отдельно?',
    install:'Стационарная или переносная установка?',
    offline:'Нужна офлайн-работа без интернета?',
    devices:'Нужна адаптация под разные устройства?',
    cast:'Нужна трансляция на экран/проектор?',
    metrics:'Собирать аналитику использования?',
    admin:'Нужна админ-панель?',
    bizgoal:'Какая бизнес-задача в приоритете?',
    kpi:'Какими метриками измерять успех?'
  };
  return missingIds.map((id,i)=> (i+1)+'. '+(MAP[id]||('Уточните: '+id))).join('\n');
}

/* ====== Концепт на основе ключей ====== */
function conceptDraftFrom(text){
  const vr=/\bvr\b|виртуал/i.test(text), ar=/\bar\b|допол/i.test(text), web=/web|веб/i.test(text);
  const platform= vr?'VR': ar?'AR': web?'Веб':'Определить на созвоне';
  const deadline=(text.match(/(\d{1,2}\.\d{1,2}\.\d{2,4}|Q[1-4]\s?\d{4}|[Яя]нвар|[Фф]еврал|Март|Апрел|Май|Июн|Июл|Август|Сентябр|Октябр|Ноябр|Декабр)/g)||[]).slice(0,2).join(', ')||'Не указано';
  const budget=(text.match(/(\d[\d\s]{2,})(?:\s?(?:₽|руб|rubl|RUB|USD|EUR))/gi)||[])[0]||'Не указан';
  let d='Название: Концепция '+platform+'-решения (черновик)\n';
  d+='Платформа: '+platform+'\nОриентир по срокам: '+deadline+'\nОриентир по инвестициям: '+budget+'\n\n';
  d+='Ключевые цитаты:\n';
  const s=(text||'').split(/[\.\!\?]\s+/).filter(s=>s.length>50&&s.length<300).slice(0,3);
  d+= s.length? s.map(x=>'— «'+x.trim()+'»').join('\n') : '— (нужно уточнить на созвоне)';
  d+='\n\nСтруктура КП (черновик):\n1) Заголовок → результат.\n2) Понимание ситуации (цитаты).\n3) Концепция без техножаргона.\n4) Путь пользователя.\n5) 2–3 варианта.\n6) Доказательства/кейсы.\n7) Инвестиции и сроки.\n8) Следующий шаг.';
  d+='\n\nПримечание: блок — конструктор, не цитаты.'; return d;
}

/* ====== Сводный документ и распределение по структуре КП ====== */
function buildFullDocument(combined, files, custom){
  let out = '';
  out += '# Сводный документ (все ответы/материалы)\n';
  out += '— Сформировано: '+new Date().toLocaleString()+'\n\n';
  out += '## Файлы\n';
  out += (files.length? files.map((f,i)=> (i+1)+'. '+f.name+' ('+Math.round(f.size/1024)+' КБ)').join('\n') : '—')+'\n\n';
  out += '## Текстовые блоки пользователя\n';
  if (custom.length){
    custom.forEach((b,i)=>{
      out += (i+1)+'. '+b.type+'\n';
      out += (b.text? '«'+b.text.trim()+'»' : '—')+'\n\n';
    });
  } else { out+='—\n\n'; }
  out += '## Цитаты из файлов и блоков (общий массив)\n';
  out += (combined||'—')+'\n';
  out += '\nПримечание: документ состоит из цитат и вложений без переформулирования.';
  return out;
}
function distributeToKPStructure(combined){
  const buckets = [
    {title:'1) Заголовочный блок (результат/для кого/за срок/без сложностей)', rx:/(результат|для|за\s\d|без\s|\broi\b|эффект)/i, items:[]},
    {title:'2) Понимание ситуации клиента (проблемы/боли/цена бездействия)', rx:/(проблем|боль|сложност|риск|бездеятель|трудност)/i, items:[]},
    {title:'3) Концепция решения (суть без жаргона)', rx:/(решени|концепц|подход|идея|предлагаем)/i, items:[]},
    {title:'4) Как это работает (путь пользователя/шаги)', rx:/(пользоват|шаг|сценар|процесс|экран|взаимодейств|маршрут)/i, items:[]},
    {title:'5) Варианты реализации (пакеты/уровни)', rx:/(вариант|пакет|базов|стандарт|премиум|уров)/i, items:[]},
    {title:'6) Почему мы (кейсы/экспертиза/доказательства)', rx:/(кейс|опыт|экспертиз|команда|доказат|портфолио)/i, items:[]},
    {title:'7) Техническая часть (оборудование/интеграции/архитектура)', rx:/(оборудов|pico|quest|vive|hololens|api|интеграц|архитектур|технол|cms)/i, items:[]},
    {title:'8) Инвестиции и сроки', rx:/(бюджет|стоимост|инвестиц|срок|дедлайн|график)/i, items:[]},
    {title:'9) Следующий шаг', rx:/(созвон|бриф|демо|пилот|следующ|дальш)/i, items:[]}
  ];
  const other = {title:'10) Не классифицировано (требует ручного разбора)', items:[]};
  const sentences = (combined||'')
    .split(/(?<=[\.\!\?])\s+/)
    .map(s=>s.trim()).filter(s=>s.length>0);

  sentences.forEach(s=>{
    const hit = buckets.find(b=> b.rx.test(s));
    (hit||other).items.push('— «'+s+'»');
  });

  let out = '';
  [...buckets, other].forEach(b=>{
    out += b.title+'\n';
    out += (b.items.length? b.items.join('\n') : '—')+'\n\n';
  });
  out += 'Примечание: распределение эвристическое; фразы — только цитаты, без перефразирования.';
  return out.trim();
}

/* ====== Построение всех выходов ====== */
function buildFilesOutputs(combined, files){
  const hits = coverageHeuristics(combined);
  const missing = REQUIRED_IDS.filter(id=>!hits.includes(id));
  const pct = Math.round((REQUIRED_IDS.length - missing.length)/REQUIRED_IDS.length*100);
  const haveList = hits.map(id=>'• '+(QUESTIONS.find(x=>x.id===id)?.text||id)).join('\n') || '—';
  const missList = missing.map(id=>'• '+(QUESTIONS.find(x=>x.id===id)?.text||id)).join('\n') || '—';
  const script = buildFollowup(missing);
  const concept = conceptDraftFrom(combined);
  const fullDoc = buildFullDocument(combined, files, analysis.custom);
  const structure = distributeToKPStructure(combined);
  return {pct, haveList, missList, script, concept, fullDoc, structure};
}

/* ====== ZIP ====== */
async function zipFiles(){
  const zip=new JSZip();
  zip.file('extracted_quotes_plus_blocks.txt',$('#extractedText').value||'');
  zip.file('full_doc.txt',$('#fullDoc').value||'');
  zip.file('structured_outline.txt',$('#structureOut').value||'');
  zip.file('concept_draft.txt',$('#concept').value||'');

  if(analysis.custom.length){
    const cf = zip.folder('custom');
    analysis.custom.forEach((b,i)=> cf.file(String(i+1).padStart(2,'0')+'_'+b.type+'.txt', b.text||''));
  }
  if(analysis.files.length){
    const af = zip.folder('attachments');
    for(const f of analysis.files){ const arr=await f.arrayBuffer(); af.file(f.name, arr); }
  }
  const blob=await zip.generateAsync({type:'blob'});
  saveAs(blob,'kp_analysis_package.zip');
}

/* ====== События UI ====== */
$('#fileInputAnalysis').addEventListener('change', e=>{
  analysis.files = Array.from(e.target.files||[]);
  renderFiles($('#fileListAnalysis'), analysis.files);
});

$('#analyze').addEventListener('click', async ()=>{
  // Извлечь из файлов
  const fileText = analysis.files.length ? await extractTextFromFiles(analysis.files) : '';
  // Собрать пользовательские блоки
  const customText = analysis.custom.map((b,i)=> `\n\n===== Блок #${i+1}: ${b.type} =====\n${(b.text||'').trim()}`).join('');
  // Итоговый комбинированный текст
  const combined = (fileText + customText).trim();
  analysis.extracted = fileText;
  analysis.combined = combined;

  $('#extractedText').value = combined || '(текст не найден)';

  const out = buildFilesOutputs(combined, analysis.files);
  $('#covPct').textContent = out.pct + '%';
  $('#covHave').textContent = out.haveList;
  $('#covMiss').textContent = out.missList;
  $('#callScript').textContent = out.script;
  $('#concept').value = out.concept;
  $('#fullDoc').value = out.fullDoc;
  $('#structureOut').value = out.structure;
});

$('#copyFiles').addEventListener('click', ()=>{
  const full = [
    '# Извлечённые цитаты + блоки',
    $('#extractedText').value,
    '',
    '# Оценка полноты',
    'Покрытие: '+$('#covPct').textContent,
    'Хватает:\n'+$('#covHave').textContent,
    'Не хватает:\n'+$('#covMiss').textContent,
    '',
    '# Скрипт вопросов',
    $('#callScript').textContent,
    '',
    '# Сводный документ',
    $('#fullDoc').value,
    '',
    '# Распределение по структуре КП',
    $('#structureOut').value,
    '',
    '# Черновик концепции КП',
    $('#concept').value
  ].join('\n');
  navigator.clipboard.writeText(full);
});
$('#zipFiles').addEventListener('click', zipFiles);
</script>
</body>
</html>
