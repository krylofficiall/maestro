<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>maestro. ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–ü, –∞–Ω–∞–ª–∏–∑ –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç</title>
<style>
  :root{
    --bg:#0b0e12; --card:#11151c; --line:#212631; --fg:#e6e7eb; --muted:#95a1b2;
    --accent:#ffffff; --accent-2:#bfc7d8; --chip:#161b22; --chip-br:#2a3140;
    --chip-hover:#1f2530; --chip-active:#2a3140; --danger:#ff4d4f; --ok:#5bef8a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
    font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
  a{color:var(--accent);text-decoration:none}
  header{border-bottom:1px solid var(--line);padding:12px 20px;display:flex;gap:16px;align-items:center;justify-content:space-between;background:#0a0d11;position:sticky;top:0;z-index:5}
  .brand{display:flex;align-items:center;gap:12px}
  .brandImgWrap{display:flex;align-items:center;gap:10px}
  #brandImg{height:28px;max-width:320px;object-fit:contain;cursor:pointer;filter:drop-shadow(0 2px 8px #0007)}
  .hint{font-size:12px;color:#b9c2d3}
  .tabs{display:flex;gap:6px}
  .tab{border:1px solid var(--line);padding:8px 12px;cursor:pointer;border-radius:999px;background:var(--chip);color:var(--accent-2);transition:.25s ease;user-select:none}
  .tab:hover{border-color:var(--accent-2);color:var(--accent)}
  .tab.active{background:#ffffff10;border-color:#ffffff44;color:#fff;box-shadow:0 0 0 1px #ffffff22 inset}
  main{max-width:1100px;margin:24px auto;padding:0 20px}
  .panel{display:none;animation:fadeIn .35s ease}
  .panel.active{display:block}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
  .card{border:1px solid var(--line);border-radius:16px;padding:14px;background:var(--card);box-shadow:0 10px 30px #00000033}
  .title{font-size:13px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:8px}
  .meta{font-size:12px;color:var(--muted)}
  .hr{border-top:1px solid var(--line);margin:14px 0}
  /* CHAT */
  .chat{height:520px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:10px;border:1px dashed var(--line);border-radius:14px;background:#0d1117;scroll-behavior:smooth}
  .msg{max-width:82%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);animation:slideUp .25s ease;white-space:pre-wrap}
  .msg.bot{align-self:flex-start;background:#0f141c}
  .msg.user{align-self:flex-end;background:#0b0e12;border-color:#ffffff33;box-shadow:0 0 0 1px #ffffff16 inset}
  .typing{width:46px;height:14px;display:flex;gap:6px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:#0f141c}
  .typing i{width:6px;height:6px;border-radius:50%;background:#74839a;animation:blink 1.2s infinite}
  .typing i:nth-child(2){animation-delay:.2s}
  .typing i:nth-child(3){animation-delay:.4s}
  .inputbar{display:flex;gap:8px;margin-top:10px}
  .inputbar textarea{flex:1;padding:12px 12px;border:1px solid var(--line);border-radius:12px;min-height:44px;background:#0d1117;color:var(--fg);outline:none;transition:border .2s ease;resize:vertical}
  .btn{border:1px solid var(--line);background:#0f141c;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s ease}
  .btn:hover{border-color:#ffffff44;background:#121a25}
  .btn.black{background:#ffffff14;color:#fff;border-color:#ffffff44}
  .btn.black:hover{background:#ffffff22}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  .chip{border:1px solid var(--chip-br);padding:8px 12px;border-radius:999px;cursor:pointer;background:var(--chip);color:#d7deee;transition:transform .06s ease, background .2s ease, border .2s ease;animation:pop .18s ease;user-select:none}
  .chip:hover{background:var(--chip-hover);border-color:#3a4254}
  .chip:active{transform:scale(.97);background:var(--chip-active)}
  .chip.ghost{border-style:dashed;color:#b7bfd1}
  .progress{height:10px;background:#0d1117;border-radius:999px;overflow:hidden;border:1px solid var(--line)}
  .bar{height:100%;background:linear-gradient(90deg,#7f8cff,#5be2ff);width:0%;transition:width .35s ease}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:6px;margin:6px 0}
  .kv div:first-child{color:var(--muted)}
  .files{display:flex;flex-wrap:wrap;gap:8px}
  .filepill{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#0d1117;color:#c7d2e2}
  pre, textarea.output{width:100%;min-height:220px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#0d1117;color:#e7e9ef;white-space:pre-wrap}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .hidden{display:none !important}
  /* custom blocks */
  .customWrap{display:flex;flex-direction:column;gap:12px;margin-top:10px}
  .customCard{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#0d1117;animation:fadeIn .25s ease}
  .customHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .badge{font-size:12px;color:#c7d2e2;background:#111827;border:1px solid var(--line);padding:4px 8px;border-radius:999px}
  .del{cursor:pointer;border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#161b22}
  .del:hover{background:#1d2532}
  .plusWrap{position:relative;display:inline-block}
  .plusBtn{border:1px solid var(--line);background:#0f141c;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .plusMenu{position:absolute;top:42px;left:0;min-width:240px;background:#0f141c;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 30px #0008;padding:8px;display:none;z-index:10}
  .plusMenu .item{padding:8px 10px;border-radius:8px;cursor:pointer}
  .plusMenu .item:hover{background:#121a25}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  @keyframes slideUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pop{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
  @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  /* hero drop */
  .drop{border:1px dashed var(--line);border-radius:12px;padding:6px 10px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brandImgWrap">
      <img id="brandImg" alt="maestro." title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—à union-dot.png">
      <input id="brandUploader" class="hidden" type="file" accept="image/*">
    </div>
    <div class="hint">maestro. ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–ü, –∞–Ω–∞–ª–∏–∑ –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç</div>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="files">–í–∞—Ä–∏–∞–Ω—Ç 1: –ê–Ω–∞–ª–∏–∑</div>
    <div class="tab" data-tab="chat">–í–∞—Ä–∏–∞–Ω—Ç 2: –£–º–Ω—ã–π —á–∞—Ç</div>
  </div>
</header>

<main>
  <!-- ===== VARIANT 1: FILE ANALYSIS (default) ===== -->
  <section id="panel-files" class="panel active">
    <div class="card">
      <div class="title">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>
      <div class="chips" style="align-items:center">
        <input id="fileInputAnalysis" type="file" multiple />
        <button id="analyze" class="btn black">–ò–∑–≤–ª–µ—á—å –∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å</button>
        <div class="plusWrap">
          <button id="plusBtn" class="plusBtn">+ –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</button>
          <div id="plusMenu" class="plusMenu">
            <div class="item" data-type="–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –∑–≤–æ–Ω–∫–∞">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –∑–≤–æ–Ω–∫–∞</div>
            <div class="item" data-type="–¢–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">–¢–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
            <div class="item" data-type="–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞">–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞</div>
            <div class="item" data-type="–ü—Ä–æ—á–∏–π —Ç–µ–∫—Å—Ç">–ü—Ä–æ—á–∏–π —Ç–µ–∫—Å—Ç</div>
          </div>
        </div>
      </div>
      <div id="fileListAnalysis" class="files"></div>

      <div class="hr"></div>
      <div class="title">–¢–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ (–¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é)</div>
      <div id="customBlocks" class="customWrap"></div>
      <div class="meta">–≠—Ç–∏ —Ç–µ–∫—Å—Ç—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ —Ü–∏—Ç–∞—Ç—ã: –≤–æ–π–¥—É—Ç –≤ –∞–Ω–∞–ª–∏–∑, —Å–≤–æ–¥–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç.</div>
    </div>

    <div class="grid" style="margin-top:24px">
      <div class="card">
        <div class="title">–ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã + –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏</div>
        <textarea id="extractedText" class="output" placeholder="–°—é–¥–∞ –ø–æ–ø–∞–¥—ë—Ç —Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–æ–≤ –∏ –∏–∑ –≤–∞—à–∏—Ö –±–ª–æ–∫–æ–≤‚Ä¶"></textarea>
      </div>
      <div class="card">
        <div class="title">–û—Ü–µ–Ω–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã</div>
        <div class="kv"><div>–ü–æ–∫—Ä—ã—Ç–∏–µ</div><div class="ok"><span id="covPct">0%</span></div></div>
        <div class="kv"><div>–•–≤–∞—Ç–∞–µ—Ç</div><div id="covHave">‚Äì</div></div>
        <div class="kv"><div>–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç</div><div id="covMiss" class="danger">‚Äì</div></div>
        <div class="hr"></div>
        <div class="title">–°–∫—Ä–∏–ø—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–æ–∑–≤–æ–Ω–∞</div>
        <pre id="callScript" style="min-height:160px"></pre>
      </div>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="title">–°–≤–æ–¥–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (–≤—Å–µ –æ—Ç–≤–µ—Ç—ã/–º–∞—Ç–µ—Ä–∏–∞–ª—ã)</div>
      <textarea id="fullDoc" class="output" placeholder="–ï–¥–∏–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –ò–ò –∏–ª–∏ –≤ –∞—Ä—Ö–∏–≤‚Ä¶"></textarea>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ö–ü (—Ü–∏—Ç–∞—Ç—ã)</div>
      <textarea id="structureOut" class="output" placeholder="–ê–≤—Ç–æ-—Ä–∞–∑–ª–æ–∂–µ–Ω–∏–µ —Ñ—Ä–∞–∑ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ö–ü‚Ä¶"></textarea>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="title">–ß–µ—Ä–Ω–æ–≤–∏–∫ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ö–ü (–ø–æ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º)</div>
      <textarea id="concept" class="output" placeholder="–ê–≤—Ç–æ-–Ω–∞–±—Ä–æ—Å–æ–∫ (–Ω–µ —Ü–∏—Ç–∞—Ç—ã). "></textarea>
      <div class="right" style="margin-top:8px">
        <button id="copyFiles" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë</button>
        <button id="zipFiles" class="btn black">–°–∫–∞—á–∞—Ç—å ZIP</button>
      </div>
      <div class="meta" style="margin-top:8px">–í–∞–∂–Ω–æ: ¬´–ß–µ—Ä–Ω–æ–≤–∏–∫ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ö–ü¬ª ‚Äî –º–∞—à–∏–Ω–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ü–∏—Ç–∞—Ç–∞–º–∏. –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Ç–æ—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.</div>
    </div>

    <div class="card" style="margin-top:24px;">
      <div class="title">–§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç (–¥–ª—è –ò–ò)</div>
      <div class="chips" style="align-items:center">
        <input id="templateInput" type="file" accept=".docx" />
        <button id="rebuildPrompt" class="btn">–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–º—Ç</button>
        <button id="copyPrompt" class="btn black">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º—Ç</button>
      </div>
      <div class="meta">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à DOCX-—à–∞–±–ª–æ–Ω –ø—Ä–æ–º—Ç–∞ ‚Äî –µ–≥–æ —Ç–µ–∫—Å—Ç –∑–∞–∫—Ä–µ–ø–∏—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ. –î–∞–ª—å—à–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤—è—Ç—Å—è —Ç–µ–∑–∏—Å—ã –∏ –≤–µ—Å—å –∫–æ—Ä–ø—É—Å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.</div>
      <textarea id="finalPrompt" class="output" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≥–æ—Ç–æ–≤—ã–π –¥–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–º—Ç ‚Äî —Å–æ ¬´–≤—à–∏—Ç—ã–º¬ª —à–∞–±–ª–æ–Ω–æ–º –∏ –≤—Å–µ–º–∏ —Ç–µ–∑–∏—Å–∞–º–∏."></textarea>
    </div>
  </section>

  <!-- ===== VARIANT 2: CHAT-ONLY ===== -->
  <section id="panel-chat" class="panel">
    <div class="card">
      <div class="title">–£–º–Ω—ã–π —á–∞—Ç (—Å–±–æ—Ä —Ñ–∞–∫—Ç–æ–≤ ‚Üí —Å—Ä–∞–∑—É –≤ –∞–Ω–∞–ª–∏–∑)</div>
      <div class="chat" id="chatBox"></div>
      <div class="chips">
        <label class="chip ghost" style="cursor:pointer">
          <input id="chatFileInput" type="file" multiple class="hidden"> + –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã
        </label>
        <div class="chip suggest" data-say="–ö–ª–∏–µ–Ω—Ç ‚Äî –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç —Ç—É—Ä–∏–∑–º–∞ –ù–ù. –ù—É–∂–Ω–∞ –∫–∞—Ä—Ç–∞ –ø–∞–º—è—Ç–Ω–∏–∫–æ–≤ (50‚Äì80 –æ–±—ä–µ–∫—Ç–æ–≤). –°—Ä–æ–∫ ‚Äî Q1 2026. –ë—é–¥–∂–µ—Ç ‚Äî 3‚Äì5 –º–ª–Ω ‚ÇΩ.">–ü—Ä–∏–º–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
        <div class="chip" data-say="–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ + –æ—Ñ–ª–∞–π–Ω-–∫—ç—à.">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</div>
        <div class="chip" data-say="–¶–ê: —Ç—É—Ä–∏—Å—Ç—ã –≤ –≥–æ—Ä–æ–¥–µ, 18‚Äì65 –ª–µ—Ç.">–¶–ê</div>
        <div class="chip" data-say="–ö–ª—é—á–µ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞ ‚Äî —á–∏—Å–ª–æ –ø–æ—Å–µ—â—ë–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫, —É–¥–µ—Ä–∂–∞–Ω–∏–µ, NPS.">KPI</div>
      </div>
      <div class="inputbar">
        <textarea id="chatInput" rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω–æ –æ –ø—Ä–æ–µ–∫—Ç–µ..."></textarea>
        <button id="sendChat" class="btn black">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div class="meta" style="margin-top:6px">–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ –∞–Ω–∞–ª–∏–∑ –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç. –ß–∞—Ç –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç—å.</div>
    </div>
  </section>
</main>

<!-- ===== LIBS ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>if(window['pdfjsLib']) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js';</script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

<script>
/* ====== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ====== */
const APP_NAME = 'maestro.';
const QUESTIONS = [
  {id:'client', text:'–ö—Ç–æ –∫–ª–∏–µ–Ω—Ç? (–∏–Ω–¥—É—Å—Ç—Ä–∏—è, —Ä–∞–∑–º–µ—Ä, —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞)', required:true},
  {id:'problem', text:'–ö–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∞–µ–º? (—Ç–µ–∫—Å—Ç–æ–º)', required:true},
  {id:'deadline', text:'–ö—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫/–∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç?', required:true},
  {id:'budget', text:'–ï—Å—Ç—å –æ—Ä–∏–µ–Ω—Ç–∏—Ä –ø–æ –±—é–¥–∂–µ—Ç—É? (–¥–∏–∞–ø–∞–∑–æ–Ω –∏–ª–∏ ¬´–Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω¬ª)', required:true},
  {id:'platform', text:'–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: VR / AR / –í–µ–± / –ú–æ–±–∏–ª—å–Ω–æ–µ / –ö–∏–æ—Å–∫ / –ö–æ–º–±–∏–Ω–∞—Ü–∏—è', required:true},
  {id:'audience', text:'–ö—Ç–æ –∫–æ–Ω–µ—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏? (–≤–æ–∑—Ä–∞—Å—Ç/—Å—Ñ–µ—Ä–∞/–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞)', required:true},
  {id:'users', text:'–°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π? (–æ–¥–∏–Ω/–≥—Ä—É–ø–ø–∞/–º–∞—Å—Å–æ–≤–æ)', required:true},
  {id:'place', text:'–ì–¥–µ –±—É–¥—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è? (–æ—Ñ–∏—Å/–≤—ã—Å—Ç–∞–≤–∫–∞/–¥–æ–º/—É–ª–∏—Ü–∞)', required:true},
  {id:'script_ready', text:'–ï—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π? (–¥–∞/–Ω–µ—Ç/—á–∞—Å—Ç–∏—á–Ω–æ)', required:true},
  {id:'duration', text:'–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ (–º–∏–Ω.)', required:true},
  {id:'interaction', text:'–¢–∏–ø –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è: –ø–∞—Å—Å–∏–≤–Ω—ã–π/–∞–∫—Ç–∏–≤–Ω—ã–π/–æ–±—É—á–µ–Ω–∏–µ/–∫–æ–º–±–∏–Ω–∞—Ü–∏—è', required:true},
  {id:'assets', text:'–ï—Å—Ç—å –ª–∏ 3D-–º–æ–¥–µ–ª–∏? (–¥–∞/–Ω–µ—Ç/–ø—Ä–∏–ª–æ–∂—É)', required:true},
  {id:'texts', text:'–ï—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç—ã/–æ–ø–∏—Å–∞–Ω–∏—è? (–¥–∞/–Ω–µ—Ç/–Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å)', required:true},
  {id:'voice', text:'–ù—É–∂–Ω–∞ –ª–∏ –¥–∏–∫—Ç–æ—Ä—Å–∫–∞—è –æ–∑–≤—É—á–∫–∞? (–¥–∞/–Ω–µ—Ç)', required:true},
  {id:'quality', text:'–ö–∞—á–µ—Å—Ç–≤–æ –≥—Ä–∞—Ñ–∏–∫–∏: —Ñ–æ—Ç–æ—Ä–µ–∞–ª–∏–∑–º/—Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è/–ø—Ä–æ—Å—Ç–∞—è', required:true},
  {id:'gear', text:'–ï—Å—Ç—å –ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ VR/AR-–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ? (–∫–∞–∫–æ–µ?)', required:true},
  {id:'gear_count', text:'–°–∫–æ–ª—å–∫–æ –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤ –Ω—É–∂–Ω–æ?', required:true},
  {id:'gear_budget', text:'–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∏—Ç –≤ –±—é–¥–∂–µ—Ç –∏–ª–∏ –∑–∞–∫—É–ø–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ?', required:true},
  {id:'install', text:'–°—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–∞—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞?', required:true},
  {id:'offline', text:'–ù—É–∂–Ω–æ –æ—Ñ–ª–∞–π–Ω-—Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞? (–¥–∞/–Ω–µ—Ç)', required:true},
  {id:'devices', text:'–ù—É–∂–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?', required:true},
  {id:'cast', text:'–ù—É–∂–Ω–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω/–ø—Ä–æ–µ–∫—Ç–æ—Ä? (–¥–∞/–Ω–µ—Ç)', required:true},
  {id:'metrics', text:'–°–æ–±–∏—Ä–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è? (–¥–∞/–Ω–µ—Ç)', required:true},
  {id:'admin', text:'–ù—É–∂–Ω–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞? (–¥–∞/–Ω–µ—Ç)', required:true},
  {id:'bizgoal', text:'–ë–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞ (–ø—Ä–æ–¥–∞–∂–∏/–æ–±—É—á–µ–Ω–∏–µ/–ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è/PR/–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ/–¥—Ä—É–≥–æ–µ)', required:true},
  {id:'kpi', text:'–ö–∞–∫ –∏–∑–º–µ—Ä—è—Ç—å —É—Å–ø–µ—Ö? (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏)', required:true}
];
const REQUIRED_IDS = QUESTIONS.filter(q=>q.required).map(q=>q.id);

const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const analysis = {
  brandDataUrl: '',           // –ª–æ–≥–æ—Ç–∏–ø union-dot.png
  files: [],                  // File[]
  custom: [],                 // {id, type, text}[]
  extracted: '',              // —Ç–µ–∫—Å—Ç –∏–∑ —Ñ–∞–π–ª–æ–≤
  combined: '',               // –æ–±—â–∏–π —Ç–µ–∫—Å—Ç: —Ñ–∞–π–ª—ã + –∫–∞—Å—Ç–æ–º + —á–∞—Ç + –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –≤ —á–∞—Ç–µ
  templateText: '',           // —Ç–µ–∫—Å—Ç –∏–∑ DOCX —à–∞–±–ª–æ–Ω–∞ –ø—Ä–æ–º—Ç–∞
  chat: []                    // {role:'user'|'bot', text:string}
};

/* ====== –ë—Ä–µ–Ω–¥/–ª–æ–≥–æ—Ç–∏–ø –≤ —à–∞–ø–∫–µ ====== */
function setBrandImg(src){
  const el = $('#brandImg');
  if(src){ el.src = src; analysis.brandDataUrl = src; }
  else { el.removeAttribute('src'); el.alt = APP_NAME; }
}
(function initBrand(){
  setBrandImg('');
  $('#brandImg').addEventListener('click', ()=> $('#brandUploader').click());
  $('#brandUploader').addEventListener('change', e=>{
    const f = e.target.files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => setBrandImg(r.result);
    r.readAsDataURL(f);
  });
  // drag & drop
  document.addEventListener('dragover', e=>{ e.preventDefault(); });
  document.addEventListener('drop', e=>{
    if(!e.dataTransfer || !e.dataTransfer.files?.length) return;
    const f = e.dataTransfer.files[0];
    if(f.type.startsWith('image/')){
      const r = new FileReader();
      r.onload = () => setBrandImg(r.result);
      r.readAsDataURL(f);
      e.preventDefault();
    }
  });
})();

/* ====== –í–∫–ª–∞–¥–∫–∏ ====== */
$$('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    $$('.panel').forEach(p=>p.classList.remove('active'));
    (t.dataset.tab==='files' ? $('#panel-files') : $('#panel-chat')).classList.add('active');
    // –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —á–∞—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —á–∞—Ç
    if(t.dataset.tab==='chat'){ const box = $('#chatBox'); box.scrollTop = box.scrollHeight; }
  });
});

/* ====== –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ ====== */
function renderFiles(node, files){
  node.innerHTML='';
  files.forEach(f=>{
    const d=document.createElement('div');
    d.className='filepill';
    d.textContent = f.name + ' (' + Math.round(f.size/1024) + ' –ö–ë)';
    node.appendChild(d);
  });
}
function readAsText(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onerror=()=>rej(new Error('read error')); r.onload=()=>res(r.result); r.readAsText(file); });}
function readAsAB(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onerror=()=>rej(new Error('ab error')); r.onload=()=>res(r.result); r.readAsArrayBuffer(file); });}
async function extractFromPDF(file){ const data=await readAsAB(file); const pdf=await pdfjsLib.getDocument({data}).promise; let full=''; for(let p=1;p<=pdf.numPages;p++){ const page=await pdf.getPage(p); const content=await page.getTextContent(); full += content.items.map(i=>i.str).join(' ')+'\n'; } return full; }
async function extractFromDOCX(file){ const data=await readAsAB(file); const out=await window.mammoth.extractRawText({arrayBuffer:data}); return out.value||''; }
async function extractTextFromFiles(files){
  let all=''; for(const f of files){ const type=f.type||''; try{
    if(type.includes('pdf')||/\.pdf$/i.test(f.name)){ all+='\n\n===== '+f.name+' (PDF) =====\n'+(await extractFromPDF(f)).trim(); }
    else if(type.includes('word')||/\.docx$/i.test(f.name)){ all+='\n\n===== '+f.name+' (DOCX) =====\n'+(await extractFromDOCX(f)).trim(); }
    else if(type.startsWith('text')||/\.(txt|md|csv|log)$/i.test(f.name)){ all+='\n\n===== '+f.name+' (TEXT) =====\n'+(await readAsText(f)||'').trim(); }
    else { all+='\n\n===== '+f.name+' (–Ω–µ –∏–∑–≤–ª–µ—á–µ–Ω–æ) =====\n[–¢–∏–ø –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω ‚Äî —Ñ–∞–π–ª –±—É–¥–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω –≤ –∞—Ä—Ö–∏–≤]'; }
  }catch(e){ all+='\n\n===== '+f.name+' (–æ—à–∏–±–∫–∞) =====\n[–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç: '+e.message+']'; } }
  return all.trim();
}

/* ====== –ö–∞—Å—Ç–æ–º–Ω—ã–µ –±–ª–æ–∫–∏ ====== */
function addCustomBlock(type){
  const id = 'block_'+Math.random().toString(36).slice(2,9);
  analysis.custom.push({id, type, text:''});
  renderCustomBlocks();
}
function removeCustomBlock(id){
  analysis.custom = analysis.custom.filter(b=>b.id!==id);
  renderCustomBlocks();
}
function renderCustomBlocks(){
  const wrap = $('#customBlocks');
  wrap.innerHTML = '';
  analysis.custom.forEach((b, idx)=>{
    const card = document.createElement('div');
    card.className = 'customCard';
    card.innerHTML = `
      <div class="customHead">
        <div class="badge">${idx+1}. ${b.type}</div>
        <div class="del" title="–£–¥–∞–ª–∏—Ç—å" data-id="${b.id}">√ó</div>
      </div>
      <textarea data-id="${b.id}" class="output" style="min-height:120px" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç‚Ä¶"></textarea>
      <div class="meta">–°–æ–≤–µ—Ç: –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –±–æ–ª—å—à–∏–µ —Ç–µ–∫—Å—Ç—ã ‚Äî –æ–Ω–∏ –≤–æ–π–¥—É—Ç –≤ –∞–Ω–∞–ª–∏–∑ –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç.</div>
    `;
    wrap.appendChild(card);
  });
  wrap.querySelectorAll('.del').forEach(btn=>{
    btn.addEventListener('click', ()=> removeCustomBlock(btn.getAttribute('data-id')));
  });
  wrap.querySelectorAll('textarea').forEach(ta=>{
    ta.addEventListener('input', ()=> {
      const id = ta.getAttribute('data-id');
      const block = analysis.custom.find(x=>x.id===id);
      if(block) block.text = (ta.value||'');
    });
  });
}
$('#plusBtn').addEventListener('click', ()=>{
  const m = $('#plusMenu');
  m.style.display = (m.style.display==='block'?'none':'block');
});
document.addEventListener('click', (e)=>{
  const m = $('#plusMenu');
  if (!m.contains(e.target) && !$('#plusBtn').contains(e.target)) m.style.display='none';
});
$('#plusMenu').querySelectorAll('.item').forEach(it=>{
  it.addEventListener('click', ()=>{
    addCustomBlock(it.getAttribute('data-type'));
    $('#plusMenu').style.display='none';
  });
});

/* ====== –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ–∫—Ä—ã—Ç–∏—è ====== */
function coverageHeuristics(text){
  text=(text||'').toLowerCase();
  const hits=new Set();
  const pats=[['client',/(–∫–ª–∏–µ–Ω—Ç|–∑–∞–∫–∞–∑—á–∏–∫|–∫–æ–º–ø–∞–Ω|–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü)/],['problem',/(–ø—Ä–æ–±–ª–µ–º|pain|–∑–∞–¥–∞—á)/],
    ['deadline',/(—Å—Ä–æ–∫|–¥–µ–¥–ª–∞–π–Ω|–∫—Ä–∞–π–Ω)/],['budget',/(–±—é–¥–∂–µ—Ç|—Å—Ç–æ–∏–º–æ—Å—Ç|–∏–Ω–≤–µ—Å—Ç–∏—Ü)/],
    ['platform',/\b(vr|ar|web|–≤–µ–±|–º–æ–±–∏–ª—å–Ω|–∫–∏–æ—Å–∫|–ø–∞–Ω–µ–ª|ios|android)\b/],['audience',/(–∞—É–¥–∏—Ç–æ—Ä–∏|–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª|—É—á–∞—â|—Å–æ—Ç—Ä—É–¥–Ω–∏–∫|–ø–æ—Å–µ—Ç–∏—Ç–µ–ª)/],
    ['users',/(–∫–æ–ª–∏—á–µ—Å—Ç–≤|–ø–æ–ª—å–∑–æ–≤–∞—Ç|–º–∞—Å—Å–æ–≤|–≥—Ä—É–ø–ø)/],['place',/(–æ—Ñ–∏—Å|–≤—ã—Å—Ç–∞–≤–∫|–¥–æ–º|—É–ª–∏—Ü|–ø–ª–æ—â–∞–¥|—à–∫–æ–ª|—É–Ω–∏–≤–µ—Ä—Å–∏—Ç|–≥–æ—Ä–æ–¥)/],
    ['script_ready',/(—Å—Ü–µ–Ω–∞—Ä|—Ç–∑|–±—Ä–∏—Ñ|–æ–ø–∏—Å–∞–Ω)/],['duration',/(–º–∏–Ω—É—Ç|–¥–ª–∏—Ç|—Å–µ–∞–Ω—Å|—Ö—Ä–æ–Ω–æ–º–µ—Ç—Ä)/],
    ['interaction',/(–æ–±—É—á–µ–Ω–∏|—Ç–µ—Å—Ç|–≥–µ–π–º–ø–ª–µ|–∏–Ω—Ç–µ—Ä–∞–∫|–ø–∞—Å—Å–∏–≤–Ω|–∞–∫—Ç–∏–≤–Ω|–≤–∏–∫—Ç–æ—Ä–∏–Ω)/],
    ['assets',/(3d|–º–æ–¥–µ–ª—å|–∞—Å—Å–µ—Ç|cad|fbx|obj|–∞–Ω–∏–º–∞—Ü)/],['texts',/(—Ç–µ–∫—Å—Ç|–∫–æ–Ω—Ç–µ–Ω—Ç|–æ–ø–∏—Å–∞–Ω|—Å—É–±—Ç–∏—Ç—Ä)/],
    ['voice',/(–æ–∑–≤—É—á|–¥–∏–∫—Ç–æ—Ä|–∞—É–¥–∏–æ|–∑–≤—É–∫|–≥–æ–ª–æ—Å)/],['quality',/(—Ñ–æ—Ç–æ—Ä–µ–∞–ª|—Ä–µ–∞–ª–∏—Å—Ç|—Å—Ç–∏–ª–∏–∑|–ø—Ä–æ—Å—Ç–∞—è –≥—Ä–∞—Ñ–∏–∫–∞)/],
    ['gear',/(pico|quest|meta|vive|hololens|–æ–±–æ—Ä—É–¥–æ–≤|—Å–º–∞—Ä—Ç—Ñ–æ–Ω|—Ç–µ–ª–µ—Ñ–æ–Ω)/],['gear_count',/(–∫–æ–º–ø–ª–µ–∫—Ç|—à–ª–µ–º|—É—Å—Ç—Ä–æ–π—Å—Ç–≤|–ø–∞—Ä–∫)/],
    ['gear_budget',/(–∑–∞–∫—É–ø–∫|–±—é–¥–∂–µ—Ç –æ–±–æ—Ä—É–¥)/],['install',/(—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω|–ø–µ—Ä–µ–Ω–æ—Å–Ω)/],
    ['offline',/(–æ—Ñ–ª–∞–π–Ω|–±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞|–∞–≤—Ç–æ–Ω–æ–º|–∫—ç—à)/],['devices',/(–∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º|android|ios|pc|windows|mac)/],
    ['cast',/(—Ç—Ä–∞–Ω—Å–ª—è—Ü|–Ω–∞ —ç–∫—Ä–∞–Ω|tv|–ø—Ä–æ–µ–∫—Ç–æ—Ä|airplay|cast)/],['metrics',/(–∞–Ω–∞–ª–∏—Ç–∏–∫|–º–µ—Ç—Ä–∏–∫|kpi|retent|–∫–æ–Ω–≤–µ—Ä—Å–∏)/],
    ['admin',/(–∞–¥–º–∏–Ω|cms|—Ä–µ–¥–∞–∫—Ç)/],['bizgoal',/(–ø—Ä–æ–¥–∞–∂|–æ–±—É—á–µ–Ω|–ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü|–º–∞—Ä–∫–µ—Ç–∏–Ω–≥|pr|–æ–±—Ä–∞–∑–æ–≤–∞–Ω|—Ç—É—Ä–∏–∑–º)/],
    ['kpi',/(roi|—Ä–æ—Å—Ç|—Å–æ–∫—Ä–∞—â–µ–Ω|–ø—Ä–æ—Ü–µ–Ω—Ç|–∫–æ–Ω–≤–µ—Ä—Å–∏|nps)/] ];
  pats.forEach(([id,rx])=> rx.test(text)&&hits.add(id));
  return [...hits];
}
function buildFollowup(missingIds){
  if (!missingIds.length) return '–í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã.';
  const MAP = {
    client:'–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –∫—Ç–æ –∑–∞–∫–∞–∑—á–∏–∫ (–∏–Ω–¥—É—Å—Ç—Ä–∏—è/—Ä–∞–∑–º–µ—Ä/—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞)?',
    problem:'–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≥–ª–∞–≤–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É –ø—Ä–æ–µ–∫—Ç–∞ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).',
    deadline:'–ö–∞–∫–æ–π –∫—Ä–∞–π–Ω–∏–π —Å—Ä–æ–∫/–∫–æ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç?',
    budget:'–ï—Å—Ç—å –ª–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä –ø–æ –±—é–¥–∂–µ—Ç—É –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω?',
    platform:'–ù–∞ –∫–∞–∫–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å–∫ (VR/AR/–≤–µ–±/–º–æ–±/–∫–∏–æ—Å–∫)?',
    audience:'–ö—Ç–æ –∫–æ–Ω–µ—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–≤–æ–∑—Ä–∞—Å—Ç/—Å—Ñ–µ—Ä–∞/–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞)?',
    users:'–°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 1 / –≥—Ä—É–ø–ø–∞ / –º–∞—Å—Å–æ–≤–æ?',
    place:'–ì–¥–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: –æ—Ñ–∏—Å/–≤—ã—Å—Ç–∞–≤–∫–∞/–¥–æ–º/—É–ª–∏—Ü–∞/–≥–æ—Ä–æ–¥?',
    script_ready:'–ï—Å—Ç—å –ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é/–¢–ó?',
    duration:'–°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –¥–ª–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç?',
    interaction:'–ö–∞–∫–æ–π —Ç–∏–ø: –ø–∞—Å—Å–∏–≤–Ω—ã–π/–∞–∫—Ç–∏–≤–Ω—ã–π/–æ–±—É—á–µ–Ω–∏–µ/–∫–æ–º–±–∏–Ω–∞—Ü–∏—è?',
    assets:'–ï—Å—Ç—å 3D-–º–æ–¥–µ–ª–∏/–∞–Ω–∏–º–∞—Ü–∏–∏? –ü—Ä–∏—à–ª–∏—Ç–µ, –µ—Å–ª–∏ –¥–∞.',
    texts:'–ï—Å—Ç—å —Ç–µ–∫—Å—Ç—ã/–æ–ø–∏—Å–∞–Ω–∏—è? –ù—É–∂–Ω–∞ –ª–∏ –ø–æ–º–æ—â—å?',
    voice:'–ù—É–∂–Ω–∞ –ª–∏ –¥–∏–∫—Ç–æ—Ä—Å–∫–∞—è –æ–∑–≤—É—á–∫–∞?',
    quality:'–ñ–µ–ª–∞–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –≥—Ä–∞—Ñ–∏–∫–∏?',
    gear:'–ï—Å—Ç—å –ª–∏ VR/AR-–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É –∫–ª–∏–µ–Ω—Ç–∞? –ö–∞–∫–æ–µ?',
    gear_count:'–°–∫–æ–ª—å–∫–æ –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤ –Ω—É–∂–Ω–æ?',
    gear_budget:'–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤ –±—é–¥–∂–µ—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ?',
    install:'–°—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–∞—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞?',
    offline:'–ù—É–∂–Ω–∞ –æ—Ñ–ª–∞–π–Ω-—Ä–∞–±–æ—Ç–∞ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞/–∫—ç—à?',
    devices:'–ù—É–∂–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞?',
    cast:'–ù—É–∂–Ω–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω/–ø—Ä–æ–µ–∫—Ç–æ—Ä?',
    metrics:'–°–æ–±–∏—Ä–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è?',
    admin:'–ù—É–∂–Ω–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å?',
    bizgoal:'–ö–∞–∫–∞—è –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞ –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ?',
    kpi:'–ö–∞–∫–∏–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏–∑–º–µ—Ä—è—Ç—å —É—Å–ø–µ—Ö?'
  };
  return missingIds.map((id,i)=> (i+1)+'. '+(MAP[id]||('–£—Ç–æ—á–Ω–∏—Ç–µ: '+id))).join('\n');
}

/* ====== –ß–µ—Ä–Ω–æ–≤–∏–∫ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ ====== */
function conceptDraftFrom(text){
  const vr=/\bvr\b|–≤–∏—Ä—Ç—É–∞–ª/i.test(text), ar=/\bar\b|–¥–æ–ø–æ–ª/i.test(text), web=/web|–≤–µ–±/i.test(text);
  const platform= vr?'VR': ar?'AR': web?'–í–µ–±':'–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ —Å–æ–∑–≤–æ–Ω–µ';
  const deadline=(text.match(/(\d{1,2}\.\d{1,2}\.\d{2,4}|Q[1-4]\s?\d{4}|[–Ø—è]–Ω–≤–∞—Ä|[–§—Ñ]–µ–≤—Ä–∞–ª|–ú–∞—Ä—Ç|–ê–ø—Ä–µ–ª|–ú–∞–π|–ò—é–Ω|–ò—é–ª|–ê–≤–≥—É—Å—Ç|–°–µ–Ω—Ç—è–±—Ä|–û–∫—Ç—è–±—Ä|–ù–æ—è–±—Ä|–î–µ–∫–∞–±—Ä)/g)||[]).slice(0,2).join(', ')||'–ù–µ —É–∫–∞–∑–∞–Ω–æ';
  const budget=(text.match(/(\d[\d\s]{2,})(?:\s?(?:‚ÇΩ|—Ä—É–±|rubl|RUB|USD|EUR))/gi)||[])[0]||'–ù–µ —É–∫–∞–∑–∞–Ω';
  let d='–ù–∞–∑–≤–∞–Ω–∏–µ: –ö–æ–Ω—Ü–µ–ø—Ü–∏—è '+platform+'-—Ä–µ—à–µ–Ω–∏—è (—á–µ—Ä–Ω–æ–≤–∏–∫)\n';
  d+='–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: '+platform+'\n–û—Ä–∏–µ–Ω—Ç–∏—Ä –ø–æ —Å—Ä–æ–∫–∞–º: '+deadline+'\n–û—Ä–∏–µ–Ω—Ç–∏—Ä –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º: '+budget+'\n\n';
  d+='–ö–ª—é—á–µ–≤—ã–µ —Ü–∏—Ç–∞—Ç—ã:\n';
  const s=(text||'').split(/[\.\!\?]\s+/).filter(s=>s.length>50&&s.length<300).slice(0,3);
  d+= s.length? s.map(x=>'‚Äî ¬´'+x.trim()+'¬ª').join('\n') : '‚Äî (–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –Ω–∞ —Å–æ–∑–≤–æ–Ω–µ)';
  d+='\n\n–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ö–ü (—á–µ—Ä–Ω–æ–≤–∏–∫):\n1) –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç.\n2) –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ (—Ü–∏—Ç–∞—Ç—ã).\n3) –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –±–µ–∑ —Ç–µ—Ö–Ω–æ–∂–∞—Ä–≥–æ–Ω–∞.\n4) –ü—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n5) 2‚Äì3 –≤–∞—Ä–∏–∞–Ω—Ç–∞.\n6) –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞/–∫–µ–π—Å—ã.\n7) –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ —Å—Ä–æ–∫–∏.\n8) –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥.';
  d+='\n\n–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –±–ª–æ–∫ ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä, –Ω–µ —Ü–∏—Ç–∞—Ç—ã.'; return d;
}

/* ====== –°–≤–æ–¥–∫–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ====== */
function buildFullDocument(combined, files, custom){
  let out = '';
  out += '# –°–≤–æ–¥–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (–≤—Å–µ –æ—Ç–≤–µ—Ç—ã/–º–∞—Ç–µ—Ä–∏–∞–ª—ã)\n';
  out += '‚Äî –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: '+new Date().toLocaleString()+'\n\n';
  out += '## –§–∞–π–ª—ã\n';
  out += (files.length? files.map((f,i)=> (i+1)+'. '+f.name+' ('+Math.round(f.size/1024)+' –ö–ë)').join('\n') : '‚Äî')+'\n\n';
  out += '## –¢–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n';
  if (custom.length){
    custom.forEach((b,i)=>{
      out += (i+1)+'. '+b.type+'\n';
      out += (b.text? '¬´'+b.text.trim()+'¬ª' : '‚Äî')+'\n\n';
    });
  } else { out+='‚Äî\n\n'; }
  out += '## –¶–∏—Ç–∞—Ç—ã –∏–∑ —Ñ–∞–π–ª–æ–≤ –∏ –±–ª–æ–∫–æ–≤ (–æ–±—â–∏–π –º–∞—Å—Å–∏–≤)\n';
  out += (combined||'‚Äî')+'\n';
  out += '\n–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ü–∏—Ç–∞—Ç –∏ –≤–ª–æ–∂–µ–Ω–∏–π –±–µ–∑ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è.';
  return out;
}
function distributeToKPStructure(combined){
  const buckets = [
    {title:'1) –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π –±–ª–æ–∫ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç/–¥–ª—è –∫–æ–≥–æ/–∑–∞ —Å—Ä–æ–∫/–±–µ–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π)', rx:/(—Ä–µ–∑—É–ª—å—Ç–∞—Ç|–¥–ª—è|–∑–∞\s\d|–±–µ–∑\s|\broi\b|—ç—Ñ—Ñ–µ–∫—Ç)/i, items:[]},
    {title:'2) –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–ø—Ä–æ–±–ª–µ–º—ã/–±–æ–ª–∏/—Ü–µ–Ω–∞ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è)', rx:/(–ø—Ä–æ–±–ª–µ–º|–±–æ–ª—å|—Å–ª–æ–∂–Ω–æ—Å—Ç|—Ä–∏—Å–∫|–±–µ–∑–¥–µ—è—Ç–µ–ª—å|—Ç—Ä—É–¥–Ω–æ—Å—Ç)/i, items:[]},
    {title:'3) –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è (—Å—É—Ç—å –±–µ–∑ –∂–∞—Ä–≥–æ–Ω–∞)', rx:/(—Ä–µ—à–µ–Ω–∏|–∫–æ–Ω—Ü–µ–ø—Ü|–ø–æ–¥—Ö–æ–¥|–∏–¥–µ—è|–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º)/i, items:[]},
    {title:'4) –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/—à–∞–≥–∏)', rx:/(–ø–æ–ª—å–∑–æ–≤–∞—Ç|—à–∞–≥|—Å—Ü–µ–Ω–∞—Ä|–ø—Ä–æ—Ü–µ—Å—Å|—ç–∫—Ä–∞–Ω|–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤|–º–∞—Ä—à—Ä—É—Ç)/i, items:[]},
    {title:'5) –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–ø–∞–∫–µ—Ç—ã/—É—Ä–æ–≤–Ω–∏)', rx:/(–≤–∞—Ä–∏–∞–Ω—Ç|–ø–∞–∫–µ—Ç|–±–∞–∑–æ–≤|—Å—Ç–∞–Ω–¥–∞—Ä—Ç|–ø—Ä–µ–º–∏—É–º|—É—Ä–æ–≤)/i, items:[]},
    {title:'6) –ü–æ—á–µ–º—É –º—ã (–∫–µ–π—Å—ã/—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞/–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞)', rx:/(–∫–µ–π—Å|–æ–ø—ã—Ç|—ç–∫—Å–ø–µ—Ä—Ç–∏–∑|–∫–æ–º–∞–Ω–¥–∞|–¥–æ–∫–∞–∑–∞—Ç|–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ)/i, items:[]},
    {title:'7) –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å (–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏/–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)', rx:/(–æ–±–æ—Ä—É–¥–æ–≤|pico|quest|vive|hololens|api|–∏–Ω—Ç–µ–≥—Ä–∞—Ü|–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä|—Ç–µ—Ö–Ω–æ–ª|cms|–æ—Ñ–ª–∞–π–Ω)/i, items:[]},
    {title:'8) –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ —Å—Ä–æ–∫–∏', rx:/(–±—é–¥–∂–µ—Ç|—Å—Ç–æ–∏–º–æ—Å—Ç|–∏–Ω–≤–µ—Å—Ç–∏—Ü|—Å—Ä–æ–∫|–¥–µ–¥–ª–∞–π–Ω|–≥—Ä–∞—Ñ–∏–∫|–∫–∞–ª–µ–Ω–¥–∞—Ä)/i, items:[]},
    {title:'9) –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥', rx:/(—Å–æ–∑–≤–æ–Ω|–±—Ä–∏—Ñ|–¥–µ–º–æ|–ø–∏–ª–æ—Ç|—Å–ª–µ–¥—É—é—â|–¥–∞–ª—å—à)/i, items:[]}
  ];
  const other = {title:'10) –ù–µ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ (—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞)', items:[]};
  const sentences = (combined||'')
    .split(/(?<=[\.\!\?])\s+/)
    .map(s=>s.trim()).filter(s=>s.length>0);

  sentences.forEach(s=>{
    const hit = buckets.find(b=> b.rx.test(s));
    (hit||other).items.push('‚Äî ¬´'+s+'¬ª');
  });

  let out = '';
  [...buckets, other].forEach(b=>{
    out += b.title+'\n';
    out += (b.items.length? b.items.join('\n') : '‚Äî')+'\n\n';
  });
  out += '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ; —Ñ—Ä–∞–∑—ã ‚Äî —Ç–æ–ª—å–∫–æ —Ü–∏—Ç–∞—Ç—ã, –±–µ–∑ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏—è.';
  return out.trim();
}

/* ====== –¢–µ–∑–∏—Å—ã –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç ====== */
function uniqueSentencesFrom(text){
  const arr = (text||'').split(/(?<=[\.\!\?])\s+/).map(s=>s.trim()).filter(Boolean);
  const seen = new Set(); const out = [];
  for(const s of arr){ const key = s.toLowerCase().replace(/\s+/g,' ').slice(0,400);
    if(!seen.has(key)){ seen.add(key); out.push(s); }
  }
  return out;
}
function buildTheses(text){
  // —Å—Ç–∞—Ä–∞–µ–º—Å—è –≤—ã—Ç–∞—â–∏—Ç—å –º–∞–∫—Å–∏–º—É–º, –Ω–æ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ, —á–µ–º –ø–æ–ª–Ω—ã–π –º–∞—Å—Å–∏–≤
  const sents = uniqueSentencesFrom(text);
  const long = sents.filter(s=>s.length>40);
  // –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –∫–ª—é—á–∞–º–∏
  const keys = /(–∫–ª–∏–µ–Ω—Ç|–∑–∞–∫–∞–∑—á–∏–∫|—Ü–µ–ª—å|–ø—Ä–æ–±–ª–µ–º|—Å—Ä–æ–∫|–±—é–¥–∂–µ—Ç|–ø–ª–∞—Ç—Ñ–æ—Ä–º|–∞—É–¥–∏—Ç–æ—Ä|–æ—Ñ–ª–∞–π–Ω|–∫–∞—Ä—Ç–∞|–¥–æ—Å—Ç–æ–ø—Ä|–∞—Ä|vr|–≤–∏–∫—Ç–æ—Ä–∏–Ω|–ø–µ—Ä—Å–æ–Ω–∞–∂|–æ–∑–≤—É—á–∫|–º–µ—Ç—Ä–∏–∫|kpi|–∏–Ω—Ç–µ–≥—Ä–∞—Ü|–æ—Ñ–∏—Å|—É–ª–∏—Ü|–º–æ–±–∏–ª|–ø—Ä–∏–ª–æ–∂–µ–Ω|–≤–µ–±)/i;
  const prioritized = long.filter(s=>keys.test(s)).concat(long.filter(s=>!keys.test(s)));
  // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –Ω–æ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –ø—Ä–æ–º—Ç–µ –º—ã –¥–æ–±–∞–≤–∏–º –∏ "–ü–æ–ª–Ω—ã–π –∫–æ—Ä–ø—É—Å"
  return prioritized.slice(0,200).map(s=>'‚Ä¢ '+s).join('\n');
}
function rebuildFinalPrompt(){
  const template = (analysis.templateText||'[–í–°–¢–ê–í–¨–¢–ï –°–í–û–ô DOCX-–®–ê–ë–õ–û–ù –ü–†–û–ú–¢–ê –ß–ï–†–ï–ó –ö–ù–û–ü–ö–£ –í–´–®–ï]\n\n‚Äî –ù–∏–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–µ–∑–∏—Å—ã –∏ –≤–µ—Å—å –∫–æ—Ä–ø—É—Å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.\n');
  const combined = analysis.combined || $('#extractedText').value || '';
  const structure = $('#structureOut').value || '';
  const fullDoc = $('#fullDoc').value || '';
  const concept = $('#concept').value || '';
  const hits = coverageHeuristics(combined);
  const missing = REQUIRED_IDS.filter(id=>!hits.includes(id));
  const follow = buildFollowup(missing);
  const theses = buildTheses(combined);

  const final =
`[BEGIN PINNED TEMPLATE ‚Äî ${APP_NAME}]
${template.trim()}
[END PINNED TEMPLATE]

[GUIDELINES]
‚Äî –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤—ã—à–µ –∫–∞–∫ –≥–ª–∞–≤–Ω—ã–π —Å—Ç–∏–ª—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
‚Äî –ù–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π —Ü–∏—Ç–∞—Ç—ã –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏; –Ω–∞ –∏—Ö –æ—Å–Ω–æ–≤–µ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –ö–ü.
‚Äî –ü–æ–∫–∞–∂–∏ –±–∏–∑–Ω–µ—Å-—Ü–µ–Ω–Ω–æ—Å—Ç—å, –∑–∞—Ç–µ–º –ø—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞—Ç–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
‚Äî –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å —á—ë—Ç–∫–∏–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.

[BRIEF THESES ‚Äî –∏–∑ –≤—Å–µ—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–Ω–æ]
${theses||'‚Äî –¢–µ–∑–∏—Å—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã.'}

[KP STRUCTURE ‚Äî —Ü–∏—Ç–∞—Ç—ã —Ä–∞–∑–ª–æ–∂–µ–Ω—ã –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º]
${structure||'‚Äî –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.'}

[CONCEPT DRAFT ‚Äî –º–∞—à–∏–Ω–Ω—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫]
${concept||'‚Äî –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.'}

[MISSING INFO ‚Äî —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã]
${follow||'‚Äî –ù–µ—Ç.'}

[FULL MATERIALS CORPUS ‚Äî –≤–∫–ª—é—á–∞–π –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, —ç—Ç–æ ¬´–∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã¬ª]
${fullDoc||combined||'‚Äî –ü—É—Å—Ç–æ.'}
`;
  $('#finalPrompt').value = final;
}

/* ====== –°—Ç—Ä–æ–∏–º –≤—Å–µ –≤—ã—Ö–æ–¥—ã ====== */
function buildFilesOutputs(combined, files){
  const hits = coverageHeuristics(combined);
  const missing = REQUIRED_IDS.filter(id=>!hits.includes(id));
  const pct = Math.round((REQUIRED_IDS.length - missing.length)/REQUIRED_IDS.length*100);
  const haveList = hits.map(id=>'‚Ä¢ '+(QUESTIONS.find(x=>x.id===id)?.text||id)).join('\n') || '‚Äî';
  const missList = missing.map(id=>'‚Ä¢ '+(QUESTIONS.find(x=>x.id===id)?.text||id)).join('\n') || '‚Äî';
  const script = buildFollowup(missing);
  const concept = conceptDraftFrom(combined);
  const fullDoc = buildFullDocument(combined, files, analysis.custom);
  const structure = distributeToKPStructure(combined);
  return {pct, haveList, missList, script, concept, fullDoc, structure};
}
function refreshOutputs(){
  const combined = analysis.combined;
  const out = buildFilesOutputs(combined, analysis.files);
  $('#covPct').textContent = out.pct + '%';
  $('#covHave').textContent = out.haveList;
  $('#covMiss').textContent = out.missList;
  $('#callScript').textContent = out.script;
  $('#concept').value = out.concept;
  $('#fullDoc').value = out.fullDoc;
  $('#structureOut').value = out.structure;
  $('#extractedText').value = combined || '(—Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω)';
  rebuildFinalPrompt();
}

/* ====== ZIP ====== */
async function zipFiles(){
  const zip=new JSZip();
  zip.file('extracted_quotes_plus_blocks.txt',$('#extractedText').value||'');
  zip.file('full_doc.txt',$('#fullDoc').value||'');
  zip.file('structured_outline.txt',$('#structureOut').value||'');
  zip.file('concept_draft.txt',$('#concept').value||'');
  zip.file('final_prompt.txt',$('#finalPrompt').value||'');

  if(analysis.custom.length){
    const cf = zip.folder('custom');
    analysis.custom.forEach((b,i)=> cf.file(String(i+1).padStart(2,'0')+'_'+b.type+'.txt', b.text||''));
  }
  if(analysis.files.length){
    const af = zip.folder('attachments');
    for(const f of analysis.files){ const arr=await f.arrayBuffer(); af.file(f.name, arr); }
  }
  if(analysis.brandDataUrl){
    // logo into assets
    const base64 = analysis.brandDataUrl.split(',')[1];
    if(base64) zip.folder('assets').file('brand.png', base64, {base64:true});
  }
  const blob=await zip.generateAsync({type:'blob'});
  saveAs(blob,'maestro_package.zip');
}

/* ====== –ê–Ω–∞–ª–∏–∑ –≤–∫–ª–∞–¥–∫–∏ ====== */
$('#fileInputAnalysis').addEventListener('change', e=>{
  analysis.files = Array.from(e.target.files||[]);
  renderFiles($('#fileListAnalysis'), analysis.files);
});
$('#analyze').addEventListener('click', async ()=>{
  const fileText = analysis.files.length ? await extractTextFromFiles(analysis.files) : '';
  const customText = analysis.custom.map((b,i)=> `\n\n===== –ë–ª–æ–∫ #${i+1}: ${b.type} =====\n${(b.text||'').trim()}`).join('');
  analysis.extracted = fileText;
  analysis.combined = (fileText + customText).trim();
  refreshOutputs();
});
$('#copyFiles').addEventListener('click', ()=>{
  const full = [
    '# –ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã + –±–ª–æ–∫–∏',
    $('#extractedText').value,
    '',
    '# –û—Ü–µ–Ω–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã',
    '–ü–æ–∫—Ä—ã—Ç–∏–µ: '+$('#covPct').textContent,
    '–•–≤–∞—Ç–∞–µ—Ç:\n'+$('#covHave').textContent,
    '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç:\n'+$('#covMiss').textContent,
    '',
    '# –°–∫—Ä–∏–ø—Ç –≤–æ–ø—Ä–æ—Å–æ–≤',
    $('#callScript').textContent,
    '',
    '# –°–≤–æ–¥–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç',
    $('#fullDoc').value,
    '',
    '# –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ö–ü',
    $('#structureOut').value,
    '',
    '# –ß–µ—Ä–Ω–æ–≤–∏–∫ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ö–ü',
    $('#concept').value
  ].join('\n');
  navigator.clipboard.writeText(full);
});
$('#zipFiles').addEventListener('click', zipFiles);

/* ====== –®–∞–±–ª–æ–Ω –ø—Ä–æ–º—Ç–∞ (DOCX) ====== */
$('#templateInput').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{
    const data = await readAsAB(f);
    const out = await window.mammoth.extractRawText({arrayBuffer:data});
    analysis.templateText = (out.value||'').trim();
  }catch(err){
    analysis.templateText = '[–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è DOCX-—à–∞–±–ª–æ–Ω–∞: '+(err?.message||'unknown')+']';
  }
  rebuildFinalPrompt();
});
$('#rebuildPrompt').addEventListener('click', rebuildFinalPrompt);
$('#copyPrompt').addEventListener('click', ()=> navigator.clipboard.writeText($('#finalPrompt').value||'') );

/* ====== –ß–∞—Ç ====== */
function chatPush(role, text){
  analysis.chat.push({role, text});
  const box = $('#chatBox');
  const m = document.createElement('div');
  m.className = 'msg '+(role==='user'?'user':'bot');
  m.textContent = text;
  box.appendChild(m);
  box.scrollTop = box.scrollHeight;
}
function smartReply(){
  const combined = analysis.combined;
  const hits = coverageHeuristics(combined);
  const missing = REQUIRED_IDS.filter(id=>!hits.includes(id));
  if(missing.length){
    chatPush('bot', '–°–ø–∞—Å–∏–±–æ! –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –µ—â—ë:\n'+buildFollowup(missing));
  } else {
    chatPush('bot', '–û—Ç–ª–∏—á–Ω–æ, –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –ö–ü –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç —É–∂–µ –≥–æ—Ç–æ–≤—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–í–∞—Ä–∏–∞–Ω—Ç 1: –ê–Ω–∞–ª–∏–∑¬ª. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –∫–µ–π—Å—ã/—Ü–∏—Ñ—Ä—ã –¥–ª—è —Å–µ–∫—Ü–∏–∏ ¬´–ü–æ—á–µ–º—É –º—ã¬ª.');
  }
}
$('#sendChat').addEventListener('click', ()=>{
  const val = ($('#chatInput').value||'').trim();
  if(!val) return;
  $('#chatInput').value='';
  chatPush('user', val);
  // –≤–∫–ª—é—á–∞–µ–º –≤ –∫–æ—Ä–ø—É—Å
  analysis.combined = (analysis.combined+'\n\n===== –ß–ê–¢ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) =====\n'+val).trim();
  refreshOutputs();
  // –∏–º–∏—Ç–∞—Ü–∏—è "–Ω–∞–±–∏—Ä–∞–µ—Ç..."
  const box = $('#chatBox');
  const t = document.createElement('div'); t.className='typing'; t.innerHTML='<i></i><i></i><i></i>'; box.appendChild(t); box.scrollTop=box.scrollHeight;
  setTimeout(()=>{ box.removeChild(t); smartReply(); }, 500);
});
$('#chatFileInput').addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  chatPush('user', 'üìé –ü—Ä–∏–∫—Ä–µ–ø–∏–ª —Ñ–∞–π–ª–æ–≤: '+files.length);
  const text = await extractTextFromFiles(files);
  analysis.combined = (analysis.combined+'\n\n===== –ß–ê–¢: –¢–ï–ö–°–¢ –ò–ó –§–ê–ô–õ–û–í =====\n'+text).trim();
  refreshOutputs();
});
$$('.chip[data-say]').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    const t = ch.getAttribute('data-say')||'';
    $('#chatInput').value = ( ($('#chatInput').value||'') ? ($('#chatInput').value+'\n') : '' ) + t;
  });
});

/* ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====== */
document.title = APP_NAME+' ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–ü, –∞–Ω–∞–ª–∏–∑ –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç';
$('#brandImg').alt = APP_NAME;
$('#brandImg').ariaLabel = APP_NAME;
$('#brandImg').title = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞—à union-dot PNG';
addCustomBlock('–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞'); // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –æ–¥–∏–Ω –±–ª–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
</script>
</body>
</html>
