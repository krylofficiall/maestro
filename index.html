<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>maestro.</title>
<style>
  :root{--bg:#0b0e12;--card:#11151c;--line:#212631;--fg:#e6e7eb;--muted:#95a1b2;--chip:#0f141c;--chip-br:#2a3140;--accent:#fff;--danger:#ff4d4f;--ok:#5bef8a}
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:9;background:#0a0d11;border-bottom:1px solid var(--line);padding:10px 18px;display:flex;align-items:center;gap:14px;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:36px}
  .tabs{display:flex;gap:6px}
  .tab{border:1px solid var(--line);padding:8px 12px;border-radius:999px;background:var(--chip);cursor:pointer;color:#c9d3e6}
  .tab.active{background:#ffffff10;border-color:#ffffff44;color:#fff}
  main{max-width:1100px;margin:24px auto;padding:0 20px}
  .panel{display:none;animation:fade .25s ease} .panel.active{display:block}
  .card{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:14px;box-shadow:0 10px 30px #0006}
  .title{font-size:13px;text-transform:uppercase;color:var(--muted);letter-spacing:.1em;margin-bottom:8px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid var(--line);background:var(--chip);color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer}
  .btn:hover{background:#121a25;border-color:#3a4254}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{border:1px solid var(--chip-br);background:#0e1420;color:#dbe3f5;padding:8px 12px;border-radius:999px;cursor:pointer}
  .chip.ghost{border-style:dashed;color:#b7bfd1}
  textarea,input[type="text"]{width:100%;background:#0d1117;color:#e6e7eb;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  .chat{min-height:380px;max-height:520px;overflow:auto;border:1px dashed var(--line);border-radius:14px;padding:10px;background:#0d1117}
  .msg{max-width:82%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);margin:8px 0}
  .bot{background:#0f141c} .user{background:#0b0e12;border-color:#ffffff33}
  .muted{color:var(--muted)}
  .hr{border-top:1px solid var(--line);margin:12px 0}
  .kv{display:grid;grid-template-columns:170px 1fr;gap:6px;font-size:14px}
  .files{display:flex;gap:8px;flex-wrap:wrap}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#0d1117}
  .danger{color:var(--danger)} .ok{color:var(--ok)}
  .footer-actions{display:flex;gap:8px;justify-content:flex-end}
  .hidden{display:none!important}
  .logoWrap{display:flex;justify-content:center;padding:26px 0}
  .logoWrap img{max-width:260px;opacity:.95}
  @keyframes fade{from{opacity:0}to{opacity:1}}
  @media (max-width: 980px){.kv{grid-template-columns:120px 1fr}}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="Union.png" alt="maestro.">
    <strong>maestro.</strong>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="chat">Умный чат</div>
    <div class="tab" data-tab="analyze">Анализ документов</div>
  </div>
</header>

<main>
  <div class="logoWrap"><img src="Union.png" alt="maestro."></div>

  <!-- ===== УМНЫЙ ЧАТ ===== -->
  <section id="panel-chat" class="panel active">
    <div class="card">
      <div class="title">Ответы по шаблону + файлы + «Моя идея»</div>
      <div class="row">
        <input id="fileChat" type="file" multiple>
        <button class="btn" id="addIdeaChat">Добавить идею</button>
        <button class="btn" id="startChat">Начать</button>
      </div>
      <div id="ideaChatBox" class="hidden" style="margin-top:8px">
        <textarea id="ideaChat" placeholder="Опиши идею — она войдёт в документ как «Моя идея»"></textarea>
      </div>
      <div class="hr"></div>
      <div class="chat" id="chatBox"></div>
      <div class="row">
        <input id="answerInput" type="text" placeholder="Ответ…">
        <button class="btn" id="sendAnswer">Ответить</button>
      </div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="title">Экспорт</div>
      <div class="kv">
        <div>Состояние</div><div id="statusChat" class="muted">ожидаю ответов…</div>
        <div>Файлы</div><div id="filesChat" class="files">—</div>
      </div>
      <div class="footer-actions" style="margin-top:8px">
        <button class="btn" id="buildDocChat">Собрать DOCX</button>
        <button class="btn" id="zipChat">Скачать ZIP</button>
      </div>
    </div>
  </section>

  <!-- ===== АНАЛИЗ ДОКУМЕНТОВ ===== -->
  <section id="panel-analyze" class="panel">
    <div class="card">
      <div class="title">Материалы заказчика</div>
      <div class="row">
        <input id="fileAnalyze" type="file" multiple>
        <button class="btn" id="addBlock">+ Добавить блок</button>
        <button class="btn" id="runAnalyze">Извлечь текст</button>
      </div>
      <div id="customList" class="files" style="margin-top:8px"></div>
      <div class="hr"></div>
      <div class="title">Извлечённый текст</div>
      <textarea id="extracted" style="min-height:220px" placeholder="Здесь появятся цитаты из файлов и пользовательских блоков…"></textarea>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="title">Экспорт</div>
      <div class="kv">
        <div>Файлы</div><div id="filesAnalyze" class="files">—</div>
        <div>Покрытие (эвристика)</div><div id="coverage" class="ok">—</div>
      </div>
      <div class="footer-actions" style="margin-top:8px">
        <button class="btn" id="buildDocAnalyze">Собрать DOCX</button>
        <button class="btn" id="zipAnalyze">Скачать ZIP</button>
      </div>
    </div>
  </section>
</main>

<!-- ===== LIBS (CDN) ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js" crossorigin="anonymous"></script>
<script>if(window['pdfjsLib']) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js';</script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.7/dist/pizzip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.46.2/build/docxtemplater.js"></script>

<script>
/*** ====== КОНФИГ ====== ***/
const USE_EXTERNAL_DOCX_TEMPLATE = false; // если true, положи template.docx в корень и добавь плейсхолдеры {answers}, {docs}, {ideas}
const TPL_PATH = 'template.docx';

/*** ====== ТЕКСТОВЫЙ ШАБЛОН (из твоего файла «Шаблон для КП.docx») ======
  Ниже — тот самый промт-шаблон (урезать не нужно). Он попадёт в начало DOCX,
  а затем мы добавим блоки «Ответы из формы», «Информация из документов», «Моя идея».
***/
const TEMPLATE_PROMPT_TEXT = `
Универсальный промт для создания продающих коммерческих предложений

Ты — эксперт по созданию высокоэффективных коммерческих предложений...
[Сокращено в интерфейсе для читаемости: положи полный текст из твоего шаблона сюда.
Если оставишь как есть — документ соберётся с этим укороченным текстом.]
`;

/*** ====== УТИЛИТЫ ====== ***/
const $ = s => document.querySelector(s); const $$ = s => Array.from(document.querySelectorAll(s));
function toPill(name,size){ return `<span class="pill">${name}${size?` (${Math.round(size/1024)} КБ)`:''}</span>` }
function readAsText(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result||'');r.onerror=rej;r.readAsText(file);});}
function readAsAB(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsArrayBuffer(file);});}
async function extractPDF(file){const data=await readAsAB(file);const pdf=await pdfjsLib.getDocument({data}).promise;let all='';for(let p=1;p<=pdf.numPages;p++){const page=await pdf.getPage(p);const c=await page.getTextContent();all+=c.items.map(i=>i.str).join(' ')+'\n';}return all;}
async function extractDOCX(file){const data=await readAsAB(file);const out=await window.mammoth.extractRawText({arrayBuffer:data});return out.value||'';}
async function extractFromFiles(files){let out='';for(const f of files){try{
  if(/\.pdf$/i.test(f.name)) out+=`\n\n===== ${f.name} (PDF) =====\n`+(await extractPDF(f)).trim();
  else if(/\.docx$/i.test(f.name)) out+=`\n\n===== ${f.name} (DOCX) =====\n`+(await extractDOCX(f)).trim();
  else if(/\.(txt|md|csv|log)$/i.test(f.name) || (f.type && f.type.startsWith('text'))) out+=`\n\n===== ${f.name} (TEXT) =====\n`+(await readAsText(f)).trim();
  else out+=`\n\n===== ${f.name} (неизвлекаемый) =====\n[Тип не поддержан в браузере]`;
}catch(e){out+=`\n\n===== ${f.name} (ошибка) =====\n[${e.message}]`}}return out.trim();}

/*** ====== ДОКУМЕНТ (DOCX) ====== ***/
async function buildDocx({templateText, answersText, docsText, ideasText, fileName='maestro.docx'}){
  if (USE_EXTERNAL_DOCX_TEMPLATE){
    // docxtemplater: template.docx должен содержать {answers}, {docs}, {ideas}
    const bin = await (await fetch(TPL_PATH)).arrayBuffer();
    const zip = new PizZip(bin); const doc = new window.docxtemplater(zip, {paragraphLoop:true,linebreaks:true});
    doc.render({answers:answersText||'', docs:docsText||'', ideas:ideasText||''});
    const blob = doc.getZip().generate({type:'blob'});
    saveAs(blob, fileName);
    return blob;
  } else {
    const {Document, Packer, Paragraph, HeadingLevel, TextRun} = window.docx;
    function para(t){return new Paragraph({children:[new TextRun({text:t})]});}
    function heading(t){return new Paragraph({text:t, heading:HeadingLevel.HEADING_2});}

    const doc = new Document({sections:[{children:[
      heading('Универсальный промт для создания продающих коммерческих предложений'),
      ...templateText.split(/\n+/).filter(x=>x.trim()).map(t=>para(t)),
      new Paragraph({}),
      heading('ОТВЕТЫ ИЗ ФОРМЫ (Ответ на форму)'),
      ...answersText.split('\n').map(para),
      new Paragraph({}),
      heading('ИНФОРМАЦИЯ ИЗ ДОКУМЕНТОВ'),
      ...docsText.split('\n').map(para),
      new Paragraph({}),
      heading('МОЯ ИДЕЯ'),
      ...ideasText.split('\n').map(para)
    ]}]});
    const blob = await Packer.toBlob(doc);
    saveAs(blob, fileName);
    return blob;
  }
}

/*** ====== ВКЛАДКИ ====== ***/
$$('.tab').forEach(t=>t.onclick=()=>{
  $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  $$('.panel').forEach(x=>x.classList.remove('active'));
  (t.dataset.tab==='chat'?$('#panel-chat'):$('#panel-analyze')).classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
});

/*** ====== РЕЖИМ «УМНЫЙ ЧАТ» ====== ***/
const QUESTIONS = [
  {id:'client', q:'Кто клиент? (индустрия, размер, специфика)', demo:'*Как правильно представить вас в КП? Чем занимаетесь и какого масштаба бизнес?*'},
  {id:'problem', q:'Какую проблему решаем?', demo:'*Если коротко — какая боль мешает достичь результата?*'},
  {id:'deadline', q:'Крайний срок / когда нужен результат?', demo:'*К какому дню должно работать — ориентир?*'},
  {id:'budget', q:'Ориентир по бюджету', demo:'*В каком диапазоне комфортно обсуждать инвестиции?*', choices:['до 1 млн ₽','1–3 млн ₽','3–7 млн ₽','7–12 млн ₽']},
  {id:'platform', q:'Платформа', demo:'*Где это живёт: VR, AR, веб, мобильное приложение, киоск?*', choices:['VR','AR','Веб','Мобильное','Киоск','Комбинация']},
  {id:'audience', q:'Кто конечные пользователи? (возраст/сфера/подготовка)', demo:'*Кто будет пользоваться прямо руками?*'},
  {id:'count', q:'Сколько пользователей (1/группа/массово)?', demo:'*Один, небольшие группы или потоки?*', choices:['1','Группа','Массово']},
  {id:'place', q:'Где используют (офис/выставка/дом/улица)?', demo:'*Основная среда использования — где?*', choices:['Офис','Выставка','Дом','Улица']},
  {id:'scenario', q:'Есть готовый сценарий/ТЗ?', demo:'*Есть ли уже набросок или делаем с нуля?*', choices:['Да','Частично','Нет','Нет информации']},
  {id:'duration', q:'Длительность пользовательского опыта (мин)', demo:'*Сколько времени идёт один проход?*', choices:['3–5','5–7','10–15','20+']},
  {id:'interaction', q:'Тип взаимодействия', demo:'*Это просмотр, тренажёр, обучение с проверкой или микс?*', choices:['Пассивный просмотр','Активный интерактив','Учебный c тестами','Комбинация','Предложить решение']},
  {id:'assets', q:'Есть ли 3D-модели/контент?', demo:'*Чем располагаете из ассетов?*', choices:['Да (пришлю)','Частично','Нет','Нужна помощь']},
  {id:'gear', q:'Есть ли оборудование у клиента?', demo:'*Какие устройства уже есть?*', choices:['Pico','Quest','Vive','HoloLens','Планшеты/смартфоны','Нет информации']},
  {id:'kpi', q:'Как измеряем успех (KPI)?', demo:'*Какие метрики покажут, что всё удалось?*'},
];

const SUGGESTIONS = {
  interaction:'Рекомендуем микс: короткие сцены с простыми действиями + быстрая проверка знаний. Такой формат даёт высокий охват и понятный результат.'
};

const chatState = {i:-1, answers:{}, files:[], idea:''};

function renderFilesList(node, files){ node.innerHTML = files.length? files.map(f=>toPill(f.name,f.size)).join(' ') : '—'; }

function chatPost(text,klass='bot'){ const div=document.createElement('div'); div.className='msg '+klass; div.innerHTML=text; $('#chatBox').appendChild(div); $('#chatBox').scrollTop=1e9; }
function askNext(){
  chatState.i++;
  if(chatState.i>=QUESTIONS.length){ $('#statusChat').textContent='все ответы получены — собери DOCX'; chatPost('<em>Спасибо! Нажми «Собрать DOCX».</em>','bot'); return; }
  const q=QUESTIONS[chatState.i];
  let chips = (q.choices||[]).map(c=>`<span class="chip" data-choice="${c}">${c}</span>`).join(' ');
  chips += ` <span class="chip ghost" data-choice="Нет информации">Нет информации</span>`;
  if(q.choices && q.choices.includes('Предложить решение')) chips += ` <span class="chip" data-suggest="${q.id}">Предложить решение</span>`;
  chatPost(`<strong>${q.q}</strong><br><span class="muted">${q.demo}</span>${q.choices?'<div class="chips" style="margin-top:6px">'+chips+'</div>':''}`);
  // клики по вариантам
  $$('#chatBox .chip').forEach(ch=>{
    ch.onclick=()=>{
      if(ch.dataset.suggest){ const t=SUGGESTIONS[ch.dataset.suggest]||'Предложим на встрече.'; handleAnswer(t); }
      else handleAnswer(ch.dataset.choice);
    }
  });
}
function handleAnswer(val){
  const q=QUESTIONS[chatState.i];
  chatState.answers[q.id]=val;
  chatPost(val,'user'); askNext();
}

$('#startChat').onclick=()=>{ $('#chatBox').innerHTML=''; chatState.i=-1; chatState.answers={}; chatPost('Поехали. Я задам ряд коротких вопросов.','bot'); askNext(); }
$('#sendAnswer').onclick=()=>{ const v=$('#answerInput').value.trim(); if(!v) return; $('#answerInput').value=''; handleAnswer(v); }
$('#addIdeaChat').onclick=()=> $('#ideaChatBox').classList.toggle('hidden');

$('#fileChat').onchange=e=>{ chatState.files = Array.from(e.target.files||[]); renderFilesList($('#filesChat'), chatState.files); }

/*** DOCX из чата ***/
async function buildFromChat(){
  // собрать ответы «вопрос → ответ»
  const ansLines = QUESTIONS.map(q=>{
    const a = chatState.answers[q.id] || '—';
    return `• ${q.q}\n  Ответ на форму: ${a}`;
  }).join('\n');
  // извлечь текст из приложенных файлов
  const docsText = chatState.files.length? await extractFromFiles(chatState.files) : '(файлы не приложены)';
  const idea = ($('#ideaChat').value||'').trim() || '(не указано)';
  $('#statusChat').textContent='собираю документ…';
  const blob = await buildDocx({templateText:TEMPLATE_PROMPT_TEXT, answersText:ansLines, docsText:docsText, ideasText:idea, fileName:'maestro_chat.docx'});
  $('#statusChat').textContent='готово: maestro_chat.docx';
  return blob;
}
$('#buildDocChat').onclick=buildFromChat;
$('#zipChat').onclick=async()=>{
  const zip=new JSZip(); const blob=await buildFromChat(); zip.file('maestro_chat.docx', blob);
  if(chatState.files.length){ const fd=zip.folder('attachments'); for(const f of chatState.files){ fd.file(f.name, await f.arrayBuffer()); } }
  saveAs(await zip.generateAsync({type:'blob'}),'maestro_chat_package.zip');
};

/*** ====== РЕЖИМ «АНАЛИЗ ДОКУМЕНТОВ» ====== ***/
const analyzeState = {files:[], blocks:[]}; // blocks: [{id,title,text}]
function rerenderBlocks(){
  const box=$('#customList'); box.innerHTML = analyzeState.blocks.length? '' : '—';
  analyzeState.blocks.forEach(b=>{
    const wrap=document.createElement('div'); wrap.className='pill'; wrap.innerHTML=`${b.title} <span class="muted">(${b.text.length} симв.)</span>`;
    box.appendChild(wrap);
  });
}
$('#fileAnalyze').onchange=e=>{ analyzeState.files = Array.from(e.target.files||[]); $('#filesAnalyze').innerHTML = analyzeState.files.length? analyzeState.files.map(f=>toPill(f.name,f.size)).join(' ') : '—'; };

$('#addBlock').onclick=()=>{
  const title = prompt('Название блока (например: Запись разговора / Формулировка задачи / Прочий текст):','Прочий текст');
  if(!title) return;
  const text = prompt('Вставь или напиши текст для блока:','');
  analyzeState.blocks.push({id:Math.random().toString(36).slice(2,9), title, text:text||''});
  rerenderBlocks();
};

$('#runAnalyze').onclick=async()=>{
  const filesText = await extractFromFiles(analyzeState.files);
  const blocksText = analyzeState.blocks.map((b,i)=>`\n\n===== ${i+1}. ${b.title} =====\n${b.text}`).join('');
  const combined = [filesText, blocksText].filter(Boolean).join('\n').trim();
  $('#extracted').value = combined || '(ничего не извлечено)';
  // условная оценка покрытия
  const have = /срок|бюджет|vr|ar|веб|платформ|сценар|kpi/i.test(combined);
  $('#coverage').textContent = have? 'есть основа (≈60–80%)' : 'данных мало (≈20–40%)';
};

async function buildFromAnalyze(){
  const docsText = $('#extracted').value.trim() || '(ничего не извлечено)';
  const ansLines = '(режим «Анализ документов» — ответы формы отсутствуют)';
  const ideas = analyzeState.blocks.filter(b=>/идея/i.test(b.title)).map(b=>b.text).join('\n') || '(не указано)';
  const blob = await buildDocx({templateText:TEMPLATE_PROMPT_TEXT, answersText:ansLines, docsText:docsText, ideasText:ideas, fileName:'maestro_analyze.docx'});
  return blob;
}
$('#buildDocAnalyze').onclick=buildFromAnalyze;
$('#zipAnalyze').onclick=async()=>{
  const zip=new JSZip(); const blob=await buildFromAnalyze(); zip.file('maestro_analyze.docx', blob);
  if(analyzeState.files.length){ const fd=zip.folder('attachments'); for(const f of analyzeState.files){ fd.file(f.name, await f.arrayBuffer()); } }
  // пользовательские блоки в отдельной папке
  if(analyzeState.blocks.length){ const cd=zip.folder('custom'); analyzeState.blocks.forEach((b,i)=>cd.file(`${String(i+1).padStart(2,'0')}_${b.title}.txt`, b.text||'')); }
  saveAs(await zip.generateAsync({type:'blob'}),'maestro_analyze_package.zip');
};

/*** Мелочи ***/
$('#ideaChat').addEventListener('input',()=>{ chatState.idea = $('#ideaChat').value; });
</script>
</body>
</html>
